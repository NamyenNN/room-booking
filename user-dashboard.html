<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard Meeting Room</title>
<style>
  :root{--card:#fff;--muted:#666;--line:#eee;--chip:#f6f6f6}
  body{font-family:system-ui,Segoe UI,Arial;padding:16px;max-width:1100px;margin:auto;background:#fafafa}
  h1{margin:0 0 12px}
  fieldset{border:1px solid #ddd;padding:12px;margin:12px 0;border-radius:12px;background:#fff}
  label{display:block;margin:6px 0 4px}
  input,select,button{padding:8px;border:1px solid #ccc;border-radius:10px;background:#fff}
  .filters{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:end}
  .hint{font-size:12px;color:var(--muted)}
  .ok{color:#0a7}
  .bad{color:#b00020}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .who{font-size:13px;color:#444}
  details{margin-top:14px}
  pre{white-space:pre-wrap}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px;margin-top:12px}
  .card{background:var(--card);border:1px solid #e9e9e9;border-radius:14px;padding:12px}
  .card h3{margin:0 0 6px;font-size:16px}
  .chip{display:inline-block;background:var(--chip);border:1px solid #e5e5e5;border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid var(--line);padding:6px 8px;text-align:left;font-size:13px;vertical-align:top}
  th{background:#f9f9f9}
  .status-badge{padding:1px 8px;border-radius:999px;border:1px solid #ddd;font-size:11px}
  .status-wait{border-color:#777;color:#777}        /* ยังไม่ถึงเวลา */
  .status-ongoing{border-color:#1565c0;color:#1565c0}/* กำลังประชุม */
  .status-confirmed{border-color:#0a7;color:#0a7}   /* ยืนยันแล้ว */
  .status-cancelled{border-color:#b00020;color:#b00020} /* ยกเลิก */
  .empty{color:#777;text-align:center;padding:12px;border:1px dashed #ddd;border-radius:8px;background:#fff}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="topbar">
  <h1>แดชบอร์ดการจองห้อง</h1>
  <div class="who" id="who">กำลังตรวจสอบผู้ใช้...</div>
</div>

<fieldset class="filters">
  <div>
    <label>จากวันที่</label>
    <input type="date" id="date_from">
  </div>
  <div>
    <label>ถึงวันที่</label>
    <input type="date" id="date_to">
  </div>
  <div>
    <label>ห้อง (ว่าง = แสดงทุกห้อง)</label>
    <select id="room"><option value="">(ทุกห้อง)</option></select>
  </div>
  <div>
    <button id="load">โหลดแดชบอร์ด</button>
  </div>
</fieldset>

<div id="msg" class="hint"></div>
<div id="dashboard"></div>

<details><summary>DEBUG</summary><pre id="debug"></pre></details>

<script>
  // ===== ตั้งค่าให้ตรงกับระบบของคุณ =====
  const API = 'https://script.google.com/macros/s/AKfycbyuudinVzhjxa3Qd_i_xZc1dQIe9AJ04dL2Ahg5x4bx94cRkadWcJ8pFihXAgEfDNekOg/exec';
  const LIFF_ID = '2008386695-b1ykgdPk';
  // ======================================

  let lineUserId = '';
  let displayName = '';
  let allRooms = [];   // [{room_id, room_name}]
  let allItems = [];   // bookings ทั้งหมด

  const $ = id => document.getElementById(id);
  const log = t => { const el=$('debug'); if(el) el.textContent += t+'\n'; };
  const msg = (t, cls='') => { const el=$('msg'); el.textContent=t; el.className='hint '+cls; };
  const toDateStr = d => d.toISOString().slice(0,10);

  // === helpers ===
  function formatDateDMY(dateStr){
    // รับ 'YYYY-MM-DD' -> 'DD - MM - YYYY'
    if(!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return '-';
    const [y,m,d] = dateStr.split('-');
    return `${d} - ${m} - ${y}`;
  }
  function parseDateTimeLocal(dateStr, timeStr){
    // dateStr: 'YYYY-MM-DD', timeStr: 'HH:MM'
    const t = (timeStr && /^\d{2}:\d{2}$/.test(timeStr)) ? timeStr : '00:00';
    return new Date(`${dateStr}T${t}:00`);
  }

  // fetch helper (กันแคช + ไม่ตั้ง header ตอน POST เพื่อเลี่ยง preflight)
  async function api(path, opt = {}){
    const url = API + path + (path.includes('?')?'&':'?') + 'v=' + Date.now();
    log('API: '+url+' method='+(opt.method||'GET'));
    const res = await fetch(url, {
      method: opt.method || 'GET',
      body: opt.body || undefined,
      mode: 'cors', credentials: 'omit', cache: 'no-store',
      redirect: 'follow', referrerPolicy: 'no-referrer'
    });
    const raw = await res.text().catch(()=> '');
    log('HTTP: '+res.status+' RAW: '+raw.slice(0,120));
    if(!res.ok) throw new Error('HTTP '+res.status+' '+raw.slice(0,200));
    try { return JSON.parse(raw); } catch { throw new Error('BAD JSON: '+raw.slice(0,200)); }
  }

  // 1) บังคับล็อกอินก่อน
  async function initLIFFRequire(){
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      liff.login({ redirectUri: location.href });
      return;
    }
    const p = await liff.getProfile();
    lineUserId = p.userId || '';
    displayName = p.displayName || '';
    $('who').textContent = `เข้าสู่ระบบ: ${displayName}`;
    log('LIFF OK user='+lineUserId);
  }

  // 2) โหลดห้องสำหรับกรอง
  async function loadRooms(){
    const d = await api('?action=rooms');
    allRooms = (d.rooms||[]).map(r=>({room_id:r.room_id, room_name:r.room_name||r.room_id}));
    const sel = $('room');
    allRooms.forEach(r=>{
      const o=document.createElement('option');
      o.value=r.room_id; o.textContent=r.room_name;
      sel.appendChild(o);
    });
  }

  // 3) โหลดการจองทั้งหมด (read-only)
  async function loadAllBookings(){
    try {
      const d = await api('?action=bookings'); // ต้องมีใน Apps Script
      allItems = d.items || [];
      log('use action=bookings (all)');
    } catch(e){
      // fallback ชั่วคราว ถ้ายังไม่มี endpoint bookings
      log('fallback to my_bookings: '+String(e));
      if(!lineUserId){ throw new Error('ต้องเปิดผ่าน LINE เพื่อดึงข้อมูลชั่วคราว'); }
      const d2 = await api(`?action=my_bookings&line_user=${encodeURIComponent(lineUserId)}`);
      allItems = d2.items || [];
      $('who').textContent += ' • (แสดงเฉพาะรายการของฉัน: API ยังไม่รองรับ bookings ทั้งหมด)';
    }
  }

  // === สถานะ: ก่อนเวลา → wait, ระหว่างเวลา → กำลังประชุม, คง cancelled/confirmed เดิม ===
  function effectiveStatus(it){
    const raw = (it.status || '').toLowerCase();
    if (raw === 'cancelled') return { label:'cancelled', cls:'status-cancelled' };

    try{
      const now = new Date();
      const startDT = parseDateTimeLocal(it.date, it.start);
      // ถ้าไม่ระบุ end → สมมติ 1 ชั่วโมง
      const endDT   = it.end && /^\d{2}:\d{2}$/.test(it.end)
        ? parseDateTimeLocal(it.date, it.end)
        : new Date(startDT.getTime() + 60*60*1000);

      if (now < startDT) {
        return { label:'wait', cls:'status-wait' };
      }
      if (now >= startDT && now <= endDT) {
        return { label:'กำลังประชุม', cls:'status-ongoing' };
      }
    }catch(e){ /* ถ้าแปลงเวลาไม่สำเร็จ → ตกไปใช้สถานะเดิม */ }

    if (raw==='confirmed' || raw==='approved') return { label: it.status, cls:'status-confirmed' };
    return { label: it.status || '-', cls:'status-badge' };
  }
  function statusBadge(it){
    const s = effectiveStatus(it);
    return `<span class="status-badge ${s.cls}">${s.label}</span>`;
  }

  // เรนเดอร์แดชบอร์ด: ทุกห้อง หรือเฉพาะห้องที่เลือก
  function renderDashboard(){
    const f = $('date_from').value, t = $('date_to').value, roomPick = $('room').value;
    const from = f ? new Date(f+'T00:00:00') : null;
    const to   = t ? new Date(t+'T23:59:59') : null;

    // กรองตามวันที่ + ห้อง
    const filtered = allItems.filter(it=>{
      if(roomPick && it.room_id !== roomPick) return false;
      const dOnly = new Date(it.date+'T00:00:00');
      if(from && dOnly < from) return false;
      if(to && dOnly > to) return false;
      return true;
    });

    // กลุ่มตามห้อง
    const byRoom = new Map();
    filtered.forEach(it=>{
      if(!byRoom.has(it.room_id)) byRoom.set(it.room_id, []);
      byRoom.get(it.room_id).push(it);
    });

    // เรียงรายการในแต่ละห้อง
    for(const arr of byRoom.values()){
      arr.sort((a,b)=>{
        const ad = a.date.localeCompare(b.date);
        if(ad!==0) return ad;
        return (a.start||'').localeCompare(b.start||'');
      });
    }

    // ถ้าไม่ได้เลือกห้อง → แสดงทุกห้อง
    const roomList = (roomPick
      ? allRooms.filter(r=>byRoom.has(r.room_id))
      : allRooms.slice().sort((a,b)=> (a.room_name||'').localeCompare(b.room_name||'')));

    if(roomList.length===0){
      $('dashboard').innerHTML = `<div class="empty">ไม่มีข้อมูลในช่วงที่เลือก</div>`;
      return;
    }

    let html = '<div class="grid">';
    roomList.forEach(r=>{
      const items = byRoom.get(r.room_id) || [];
      html += `<div class="card">
        <h3>${r.room_name}</h3>
        <div class="hint">รายการ ${items.length} รายการ</div>
        ${items.length ? `
          <table>
            <thead><tr>
              <th style="width:140px">วันที่</th>
              <th style="width:100px">เวลา</th>
              <th>ผู้จอง</th>
              <th>วัตถุประสงค์</th>
              <th style="width:110px">สถานะ</th>
            </tr></thead>
            <tbody>
              ${items.map(it=>`
                <tr>
                  <td>${formatDateDMY(it.date)}</td>
                  <td>${(it.start||'-')+'-'+(it.end||'-')}</td>
                  <td>${it.by||'-'}</td>
                  <td>${it.purpose||'-'}</td>
                  <td>${statusBadge(it)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        ` : `<div class="empty">ยังไม่มีการจอง</div>`}
      </div>`;
    });
    html += '</div>';
    $('dashboard').innerHTML = html;
  }

  async function runLoad(){
    msg('กำลังโหลด...', '');
    await loadAllBookings();
    renderDashboard();
    msg('โหลดเสร็จแล้ว', 'ok');
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    // default date = วันนี้ → อีก 60 วัน
    const today = new Date();
    const twoM  = new Date(); twoM.setDate(today.getDate()+60);
    $('date_from').value = toDateStr(today);
    $('date_to').value   = toDateStr(twoM);

    await initLIFFRequire();   // ต้องล็อกอินก่อน
    await loadRooms();         // รายชื่อห้อง

    $('load').onclick = runLoad;
    // เปลี่ยนตัวกรองแล้วเรนเดอร์ทันที (ไม่ยิง API ใหม่)
    $('room').onchange = ()=> renderDashboard();
    $('date_from').onchange = ()=> renderDashboard();
    $('date_to').onchange = ()=> renderDashboard();

    // โหลดรอบแรก → แดชบอร์ดทุกห้อง
    runLoad().catch(e=> msg('❌ โหลดไม่สำเร็จ: '+String(e), 'bad'));
  });
</script>
</body>
</html>
