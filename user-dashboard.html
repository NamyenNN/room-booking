<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (Live)</title>

<style>
  :root{
    --bg:#020617;
    --card:#0f172a;
    --line:#1e293b;
    --text:#e5e7eb;
    --muted:#94a3b8;
    --free:#22c55e;
    --busy:#ef4444;
    --soon:#facc15;
  }

  body{
    margin:0;
    padding:32px;
    font-family:system-ui,Segoe UI,Arial;
    background:var(--bg);
    color:var(--text);
  }

  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
    flex-wrap:wrap;
    gap:12px;
  }

  h1{
    margin:0;
    font-size:36px;
    font-weight:900;
    letter-spacing:.5px;
  }

  .time{
    font-size:18px;
    color:var(--muted);
  }

  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
    gap:24px;
  }

  .room{
    background:var(--card);
    border-radius:24px;
    padding:24px;
    border:1px solid var(--line);
    box-shadow:0 20px 40px rgba(0,0,0,.4);
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .room h2{
    margin:0;
    font-size:28px;
    font-weight:800;
  }

  .status{
    font-size:26px;
    font-weight:900;
  }
  .free{color:var(--free);}
  .busy{color:var(--busy);}
  .soon{color:var(--soon);}

  .detail{
    font-size:18px;
    color:var(--muted);
    line-height:1.5;
  }

  footer{
    margin-top:24px;
    font-size:14px;
    color:var(--muted);
    text-align:right;
  }
</style>
</head>

<body>

<header>
  <h1>üì∫ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h1>
  <div class="time" id="clock">--:--</div>
</header>

<div id="grid" class="grid"></div>

<footer id="updated">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</footer>

<script>
/* ================= CONFIG ================= */
const API = 'https://script.google.com/macros/s/AKfycbyKKtN_gWMWEW30eCjgfWSfF9m1AWPtYweRoPV7VPkPx21HoyhQO5oGGkbi08VsmcxCIQ/exec';
const REFRESH_SEC = 10;   // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å‡∏Å‡∏µ‡πà‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
const SOON_MIN = 15;      // ‡∏Å‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° = ‡∏Ç‡∏∂‡πâ‡∏ô "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°"
/* ========================================= */

function nowMinutes(){
  const d=new Date();
  return d.getHours()*60 + d.getMinutes();
}

function updateClock(){
  const d=new Date();
  document.getElementById('clock').textContent =
    d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

async function load(){
  const today = new Date().toISOString().slice(0,10);
  const res = await fetch(`${API}?action=calendar&date_from=${today}&date_to=${today}&v=${Date.now()}`);
  const data = await res.json();
  render(data.items || []);
  document.getElementById('updated').textContent =
    '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ' + new Date().toLocaleTimeString();
}

function render(items){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';

  if(!items.length){
    grid.innerHTML = '<div style="color:#94a3b8;font-size:22px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
    return;
  }

  const byRoom = {};
  items.forEach(it=>{
    if(!byRoom[it.room_id]) byRoom[it.room_id]=[];
    byRoom[it.room_id].push(it);
  });

  const now = nowMinutes();

  Object.keys(byRoom).forEach(room=>{
    const bookings = byRoom[room];
    let cls='free', text='‡∏ß‡πà‡∏≤‡∏á', detail='';

    for(const b of bookings){
      const [sh,sm] = b.start.split(':').map(Number);
      const [eh,em] = b.end.split(':').map(Number);
      const s = sh*60+sm;
      const e = eh*60+em;

      if(now>=s && now<e){
        cls='busy';
        text='üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        detail=`${b.start} ‚Äì ${b.end}<br>${b.by||''}`;
        break;
      }
      if(now<s && s-now<=SOON_MIN){
        cls='soon';
        text=`üü° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô ${s-now} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        detail=`${b.start} ‚Äì ${b.end}<br>${b.by||''}`;
      }
    }

    const el=document.createElement('div');
    el.className='room';
    el.innerHTML=`
      <h2>${room}</h2>
      <div class="status ${cls}">${text}</div>
      <div class="detail">${detail || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ'}</div>
    `;
    grid.appendChild(el);
  });
}

/* ===== START ===== */
updateClock();
setInterval(updateClock,1000);
load();
setInterval(load, REFRESH_SEC*1000);
</script>

</body>
</html>
