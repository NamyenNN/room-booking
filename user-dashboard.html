<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard Meeting </title>
<style>
  :root{--card:#fff;--muted:#666;--line:#eee;--chip:#f6f6f6}
  body{font-family:system-ui,Segoe UI,Arial;padding:16px;max-width:1100px;margin:auto;background:#fafafa}
  h1{margin:0 0 12px}
  fieldset{border:1px solid #ddd;padding:12px;margin:12px 0;border-radius:12px;background:#fff}
  label{display:block;margin:6px 0 4px}
  input,select,button{padding:8px;border:1px solid #ccc;border-radius:10px;background:#fff}
  .filters{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:end}
  .hint{font-size:12px;color:var(--muted)}
  .ok{color:#0a7}
  .bad{color:#b00020}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .who{font-size:13px;color:#444}
  details{margin-top:14px}
  pre{white-space:pre-wrap}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px;margin-top:12px}
  .card{background:var(--card);border:1px solid #e9e9e9;border-radius:14px;padding:12px}
  .card h3{margin:0 0 6px;font-size:16px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid var(--line);padding:6px 8px;text-align:left;font-size:13px;vertical-align:top}
  th{background:#f9f9f9}
  .status-badge{padding:1px 8px;border-radius:999px;border:1px solid #ddd;font-size:11px}
  .status-wait{border-color:#777;color:#777}
  .status-ongoing{border-color:#1565c0;color:#1565c0}
  .status-confirmed{border-color:#0a7;color:#0a7}
  .status-cancelled{border-color:#b00020;color:#b00020}
  .empty{color:#777;text-align:center;padding:12px;border:1px dashed #ddd;border-radius:8px;background:#fff}

  /* Timeline */
  .timeline-wrap{margin-top:8px}
  .timeline-head{display:flex;justify-content:space-between;font-size:11px;color:#555;margin:2px 2px 4px}
  .timeline{position:relative;height:26px;border:1px solid #e5e5e5;border-radius:8px;background:#fff;overflow:hidden}
  .tick{position:absolute;top:0;bottom:0;width:1px;background:#f0f0f0}
  .slot{position:absolute;top:2px;bottom:2px;border-radius:6px;border:1px solid #cfe3ff;background:#eaf3ff;font-size:11px;line-height:22px;padding:0 6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .slot.ongoing{border-color:#bcdcff;background:#e3f0ff;box-shadow:0 0 0 1px rgba(21,101,192,.08) inset}
  .slot.cancelled{border-color:#f2c4c4;background:#fdeeee;color:#b00020;text-decoration:line-through}
  .timeline-legend{font-size:11px;color:#666;margin-top:4px}
</style>
</head>
<body>
<div class="topbar">
  <h1>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</h1>
  <div class="who" id="who">‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ ‚Ä¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
</div>

<fieldset class="filters">
  <div>
    <label>‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
    <input type="date" id="date_from">
  </div>
  <div>
    <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
    <input type="date" id="date_to">
  </div>
  <div>
    <label>‡∏´‡πâ‡∏≠‡∏á (‡∏ß‡πà‡∏≤‡∏á = ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á)</label>
    <select id="room"><option value="">(‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á)</option></select>
  </div>
  <div>
    <button id="load">‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
  </div>
</fieldset>

<div id="msg" class="hint"></div>
<div id="dashboard"></div>

<details><summary>DEBUG</summary><pre id="debug"></pre></details>

<script>
  // ===== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì =====
  const API = 'https://script.google.com/macros/s/AKfycbyuudinVzhjxa3Qd_i_xZc1dQIe9AJ04dL2Ahg5x4bx94cRkadWcJ8pFihXAgEfDNekOg/exec';
  // ======================================

  let allRooms = [];   // [{room_id, room_name}]
  let allItems = [];   // bookings ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏à‡∏≤‡∏Å calendar)

  const $ = id => document.getElementById(id);
  const log = t => { const el=$('debug'); if(el) el.textContent += t+'\n'; };
  const msg = (t, cls='') => { const el=$('msg'); el.textContent=t; el.className='hint '+cls; };
  const toDateStr = d => d.toISOString().slice(0,10);

  // === helpers ===
  function formatDateDMY(dateStr){
    if(!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return '-';
    const [y,m,d] = dateStr.split('-');
    return `${d} - ${m} - ${y}`;
  }
  function parseDateTimeLocal(dateStr, timeStr){
    const t = (timeStr && /^\d{2}:\d{2}$/.test(timeStr)) ? timeStr : '00:00';
    return new Date(`${dateStr}T${t}:00`);
  }

  // fetch helper
  async function api(path, opt = {}){
    const url = API + path + (path.includes('?')?'&':'?') + 'v=' + Date.now();
    log('API: '+url+' method='+(opt.method||'GET'));
    const res = await fetch(url, { method: opt.method || 'GET', body: opt.body || undefined, mode: 'cors', credentials: 'omit', cache: 'no-store', redirect: 'follow', referrerPolicy: 'no-referrer' });
    const raw = await res.text().catch(()=> '');
    log('HTTP: '+res.status+' RAW: '+raw.slice(0,200));
    if(!res.ok) throw new Error('HTTP '+res.status+' '+raw.slice(0,200));
    try { return JSON.parse(raw); } catch { throw new Error('BAD JSON: '+raw.slice(0,200)); }
  }

  // 1) ‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏á
  async function loadRooms(){
    const d = await api('?action=rooms');
    allRooms = (d.rooms||[]).map(r=>({room_id:r.room_id, room_name:r.room_name||r.room_id}));
    const sel = $('room');
    allRooms.forEach(r=>{
      const o=document.createElement('option');
      o.value=r.room_id; o.textContent=r.room_name;
      sel.appendChild(o);
    });
  }

  // 2) ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á:
  //    - ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å bookings ‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ endpoint ‡∏ô‡∏µ‡πâ)
  //    - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ/‡∏ß‡πà‡∏≤‡∏á ‚Üí ‡πÉ‡∏ä‡πâ calendar ‡πÅ‡∏ó‡∏ô (‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÄ‡∏î‡∏¥‡∏°)
  async function loadAllBookings(){
    const f = $('date_from').value;
    const t = $('date_to').value;
    const roomPick = $('room').value || '';

    // 2.1 ‡∏•‡∏≠‡∏á bookings (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå‡∏ö‡∏≤‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô)
    try{
      const b = await api('?action=bookings' + (roomPick ? '&room_id='+encodeURIComponent(roomPick): '') + (f? '&date_from='+f:'') + (t? '&date_to='+t:''));
      if (b && b.ok && Array.isArray(b.items) && b.items.length){
        allItems = b.items.map(x=>({
          ref:x.ref, room_id:x.room_id, date:x.date, start:x.start, end:x.end, by:x.by, purpose:x.purpose,
          status: (x.status || 'confirmed') // ‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏¥‡∏•‡∏î‡πå
        }));
        log('USED: bookings ('+allItems.length+' items)');
        return;
      }
    }catch(err){
      log('bookings failed: '+String(err));
    }

    // 2.2 fallback ‚Üí calendar (‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà cancelled ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
    const c = await api(`?action=calendar${roomPick?('&room_id='+encodeURIComponent(roomPick)) : ''}${f?('&date_from='+f):''}${t?('&date_to='+t):''}`);
    const items = (c.items || []).map(x=>({
      ref:x.ref, room_id:x.room_id, date:x.date, start:x.start, end:x.end, by:x.by, purpose:x.purpose,
      status:'confirmed'
    }));
    allItems = items;
    log('USED: calendar ('+allItems.length+' items)');
  }

  // === ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: wait / ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° / confirmed / cancelled ===
  function effectiveStatus(it){
    const raw = (it.status || '').toLowerCase();
    if (raw === 'cancelled') return { label:'cancelled', cls:'status-cancelled' };

    try{
      const now = new Date();
      const startDT = parseDateTimeLocal(it.date, it.start);
      const endDT   = it.end && /^\d{2}:\d{2}$/.test(it.end)
        ? parseDateTimeLocal(it.date, it.end)
        : new Date(startDT.getTime() + 60*60*1000);

      if (now < startDT) return { label:'wait', cls:'status-wait' };
      if (now >= startDT && now <= endDT) return { label:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°', cls:'status-ongoing' };
    }catch(e){}

    return { label: raw || 'confirmed', cls:'status-confirmed' };
  }
  function statusBadge(it){
    const s = effectiveStatus(it);
    return `<span class="status-badge ${s.cls}">${s.label}</span>`;
  }

  // ===== Timeline helpers =====
  const TL_START = 7;   // 07:00
  const TL_END   = 20;  // 20:00
  const TL_SPAN  = (TL_END - TL_START) * 60; // ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  function hmToMinutes(hm){ const [h,m]=(hm||'00:00').split(':').map(Number); return (h*60+m); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function renderTimeline(roomId, itemsForRoomOnDate, dateStr){
    let head = '<div class="timeline-head"><span>'+formatDateDMY(dateStr)+'</span><span>‡πÄ‡∏ß‡∏•‡∏≤ '+String(TL_START).padStart(2,'0')+':00 - '+TL_END+':00</span></div>';
    let html = '<div class="timeline">';
    for(let hr=TL_START+1; hr<=TL_END-1; hr++){
      const left = ((hr - TL_START) / (TL_END - TL_START)) * 100;
      html += `<div class="tick" style="left:${left}%"></div>`;
    }
    itemsForRoomOnDate.forEach(it=>{
      const sM = hmToMinutes(it.start || '00:00');
      const eM = hmToMinutes(it.end || '00:00');
      const sClamped = clamp(sM, TL_START*60, TL_END*60);
      const eClamped = clamp(eM || sClamped+60, TL_START*60, TL_END*60);
      const widthMin = Math.max((eClamped - sClamped), 10);
      const leftPct  = ((sClamped - TL_START*60) / TL_SPAN) * 100;
      const widthPct = (widthMin / TL_SPAN) * 100;

      const st = effectiveStatus(it);
      const label = `${it.start||'-'}-${it.end||'-'} ‚Ä¢ ${it.by||'-'}`;
      const cls = `slot ${st.cls === 'status-ongoing' ? 'ongoing' : ''} ${st.cls === 'status-cancelled' ? 'cancelled' : ''}`;
      html += `<div class="${cls}" title="${label}" style="left:${leftPct}%;width:${widthPct}%">${label}</div>`;
    });

    html += '</div><div class="timeline-legend">* ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</div>';
    return '<div class="timeline-wrap">'+head+html+'</div>';
  }

  // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
  function renderDashboard(){
    const f = $('date_from').value, t = $('date_to').value, roomPick = $('room').value;

    // ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á YYYY-MM-DD ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    const fromS = f || null;
    const toS   = t || null;
    const singleDay = !!(f && t && f === t);

    const filtered = allItems.filter(it=>{
      if(roomPick && it.room_id !== roomPick) return false;
      if(fromS && it.date < fromS) return false;
      if(toS && it.date > toS) return false;
      return true;
    });

    // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á
    const byRoom = new Map();
    filtered.forEach(it=>{
      if(!byRoom.has(it.room_id)) byRoom.set(it.room_id, []);
      byRoom.get(it.room_id).push(it);
    });

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á
    for(const arr of byRoom.values()){
      arr.sort((a,b)=>{
        const ad = a.date.localeCompare(b.date);
        if(ad!==0) return ad;
        return (a.start||'').localeCompare(b.start||'');
      });
    }

    const roomList = (roomPick
      ? allRooms.filter(r=>byRoom.has(r.room_id))
      : allRooms.slice().sort((a,b)=> (a.room_name||'').localeCompare(b.room_name||'')));

    if(roomList.length===0){
      $('dashboard').innerHTML = `<div class="empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>`;
      return;
    }

    let html = '<div class="grid">';
    roomList.forEach(r=>{
      const items = byRoom.get(r.room_id) || [];
      const itemsToday = singleDay ? items.filter(it => it.date === f) : [];

      html += `<div class="card">
        <h3>${r.room_name}</h3>
        ${singleDay ? renderTimeline(r.room_id, itemsToday, f) : ''}
        <div class="hint">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£${singleDay ? ' ‚Ä¢ ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß' : ''}</div>
        ${items.length ? `
          <table>
            <thead><tr>
              <th style="width:140px">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th style="width:100px">‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th>
              <th>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</th>
              <th style="width:110px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            </tr></thead>
            <tbody>
              ${items.map(it=>`
                <tr>
                  <td>${formatDateDMY(it.date)}</td>
                  <td>${(it.start||'-')+'-'+(it.end||'-')}</td>
                  <td>${it.by||'-'}</td>
                  <td>${it.purpose||'-'}</td>
                  <td>${statusBadge(it)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        ` : `<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</div>`}
      </div>`;
    });
    html += '</div>';

    if(!singleDay){
      html += `<div class="hint" style="margin-top:8px">üí° ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏´‡πá‡∏ô ‚Äú‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‚Äù ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</div>`;
    }

    $('dashboard').innerHTML = html;
  }

  async function runLoad(){
    msg('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', '');
    await loadRooms();
    await loadAllBookings(); // now uses bookings -> fallback calendar
    renderDashboard();
    msg('‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'ok');
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    // default date = ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Üí ‡∏≠‡∏µ‡∏Å 60 ‡∏ß‡∏±‡∏ô
    const today = new Date();
    const twoM  = new Date(); twoM.setDate(today.getDate()+60);
    $('date_from').value = toDateStr(today);
    $('date_to').value   = toDateStr(twoM);

    $('load').onclick = runLoad;
    // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á ‡∏Å‡πá‡∏î‡∏∂‡∏á‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å calendar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏à‡∏£‡∏¥‡∏á
    $('room').onchange = async ()=>{ await loadAllBookings(); renderDashboard(); };
    $('date_from').onchange = async ()=>{ await loadAllBookings(); renderDashboard(); };
    $('date_to').onchange = async ()=>{ await loadAllBookings(); renderDashboard(); };

    runLoad().catch(e=> msg('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+String(e), 'bad'));
  });
</script>
</body>
</html>
