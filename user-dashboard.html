<script>
  // ===== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì =====
  const API = 'https://script.google.com/macros/s/AKfycbyuudinVzhjxa3Qd_i_xZc1dQIe9AJ04dL2Ahg5x4bx94cRkadWcJ8pFihXAgEfDNekOg/exec';
  const POLL_SEC = 7; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 7 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  // ======================================

  let allRooms = [];
  let allItems = [];
  let pollTimer = null;
  let lastHash = '';

  const $ = id => document.getElementById(id);
  const log = t => { const el=$('debug'); if(el) el.textContent += t + '\n'; };
  const msg = (t, cls='') => { const el=$('msg'); el.textContent=t; el.className='hint '+cls; };
  const toDateStr = d => d.toISOString().slice(0,10);
  const nowStamp = ()=> new Date().toLocaleString();

  // === helpers ===
  function formatDateDMY(dateStr){
    if(!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return '-';
    const parts = dateStr.split('-');
    const y = parts[0], m = parts[1], d = parts[2];
    return d + ' - ' + m + ' - ' + y;
  }

  function parseDateTimeLocal(dateStr, timeStr){
    const t = (timeStr && /^\d{2}:\d{2}$/.test(timeStr)) ? timeStr : '00:00';
    return new Date(dateStr + 'T' + t + ':00');
  }

  function itemsHash(items){
    return JSON.stringify(
      items.map(function(x){
        return [x.ref,x.room_id,x.date,x.start,x.end,x.by,x.purpose,x.status];
      }).sort()
    );
  }

  // fetch helper
  async function api(path, opt){
    opt = opt || {};
    const url = API + path + (path.indexOf('?') >= 0 ? '&' : '?') + 'v=' + Date.now();
    log('API: ' + url + ' method=' + (opt.method || 'GET'));
    const res = await fetch(url, {
      method: opt.method || 'GET',
      body: opt.body || undefined,
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-store',
      redirect: 'follow',
      referrerPolicy: 'no-referrer'
    });
    const raw = await res.text().catch(function(){ return ''; });
    log('HTTP: ' + res.status + ' RAW: ' + raw.slice(0,200));
    if(!res.ok) throw new Error('HTTP ' + res.status + ' ' + raw.slice(0,200));
    try{
      return JSON.parse(raw);
    }catch(e){
      throw new Error('BAD JSON: ' + raw.slice(0,200));
    }
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á
  async function loadRooms(){
    const d = await api('?action=rooms');
    allRooms = (d.rooms || []).map(function(r){
      return {
        room_id: r.room_id,
        room_name: r.room_name || r.room_id
      };
    });
    const sel = $('room');
    sel.innerHTML = '<option value="">(‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á)</option>';
    allRooms.forEach(function(r){
      const o = document.createElement('option');
      o.value = r.room_id;
      o.textContent = r.room_name;
      sel.appendChild(o);
    });
  }

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏à‡∏≤‡∏Å calendar
  async function loadAllBookings(){
    const f = $('date_from').value;
    const t = $('date_to').value;
    const roomPick = $('room').value || '';

    let path = '?action=calendar';
    if(roomPick) path += '&room_id=' + encodeURIComponent(roomPick);
    if(f) path += '&date_from=' + f;
    if(t) path += '&date_to=' + t;

    const d = await api(path);
    allItems = (d.items || []).map(function(x){
      const obj = {};
      for(const k in x) obj[k] = x[k];
      obj.status = 'confirmed';
      return obj;
    });
  }

  // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  function effectiveStatus(it){
    try{
      const now = new Date();
      const s = parseDateTimeLocal(it.date, it.start);
      const isValidEnd = it.end && /^\d{2}:\d{2}$/.test(it.end);
      const e = isValidEnd ? parseDateTimeLocal(it.date, it.end) : new Date(s.getTime() + 60*60*1000);

      if(now < s) return { label:'wait', cls:'status-wait' };
      if(now >= s && now <= e) return { label:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°', cls:'status-ongoing' };
      return { label:'confirmed', cls:'status-confirmed' };
    }catch(err){
      return { label:'confirmed', cls:'status-confirmed' };
    }
  }

  function statusBadge(it){
    const s = effectiveStatus(it);
    return '<span class="status-badge ' + s.cls + '">' + s.label + '</span>';
  }

  // ===== Timeline (‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ single day) =====
  const TL_START = 7;
  const TL_END   = 20;
  const TL_SPAN  = (TL_END - TL_START) * 60;

  function hmToMinutes(hm){
    const parts = (hm || '00:00').split(':');
    const h = parseInt(parts[0] || '0',10);
    const m = parseInt(parts[1] || '0',10);
    return h * 60 + m;
  }

  function clamp(v, min, max){
    return Math.max(min, Math.min(max, v));
  }

  function renderTimeline(roomId, itemsForRoomOnDate, dateStr){
    let head =
      '<div class="timeline-head"><span>' +
      formatDateDMY(dateStr) +
      '</span><span>‡πÄ‡∏ß‡∏•‡∏≤ ' +
      String(TL_START).padStart(2,'0') +
      ':00 - ' +
      TL_END +
      ':00</span></div>';

    let html = '<div class="timeline">';
    for(let hr = TL_START + 1; hr <= TL_END - 1; hr++){
      const left = ((hr - TL_START) / (TL_END - TL_START)) * 100;
      html += '<div class="tick" style="left:' + left + '%"></div>';
    }

    itemsForRoomOnDate.forEach(function(it){
      const sM = hmToMinutes(it.start || '00:00');
      const eM = hmToMinutes(it.end   || '00:00') || (sM + 60);
      const sC = clamp(sM, TL_START * 60, TL_END * 60);
      const eC = clamp(eM, TL_START * 60, TL_END * 60);
      const leftPct  = ((sC - TL_START * 60) / TL_SPAN) * 100;
      const widthPct = (Math.max(eC - sC, 10) / TL_SPAN) * 100;

      const on = effectiveStatus(it).cls === 'status-ongoing';
      const titleText =
        (it.start || '-') + '-' + (it.end || '-') +
        ' - ' + (it.by || '-');

      html +=
        '<div class="slot ' + (on ? 'ongoing' : '') + '"' +
        ' title="' + titleText + '"' +
        ' style="left:' + leftPct + '%;width:' + widthPct + '%">' +
        (it.start || '-') + '-' + (it.end || '-') + ' - ' + (it.by || '-') +
        '</div>';
    });

    html += '</div><div class="timeline-legend">* ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</div>';
    return '<div class="timeline-wrap">' + head + html + '</div>';
  }

  // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
  function renderDashboard(){
    const f = $('date_from').value;
    const t = $('date_to').value;
    const roomPick = $('room').value;

    const fromS = f || null;
    const toS   = t || null;
    const singleDay = !!(f && t && f === t);

    const filtered = allItems.filter(function(it){
      if(roomPick && it.room_id !== roomPick) return false;
      if(fromS && it.date < fromS) return false;
      if(toS   && it.date > toS)   return false;
      return true;
    });

    const byRoom = new Map();
    filtered.forEach(function(it){
      if(!byRoom.has(it.room_id)) byRoom.set(it.room_id, []);
      byRoom.get(it.room_id).push(it);
    });

    byRoom.forEach(function(arr){
      arr.sort(function(a,b){
        const d = a.date.localeCompare(b.date);
        if(d !== 0) return d;
        return (a.start || '').localeCompare(b.start || '');
      });
    });

    const roomList = roomPick
      ? allRooms.filter(function(r){ return byRoom.has(r.room_id); })
      : allRooms.slice().sort(function(a,b){
          return (a.room_name || '').localeCompare(b.room_name || '');
        });

    if(roomList.length === 0){
      $('dashboard').innerHTML =
        '<div class="empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>';
      return;
    }

    let html = '<div class="grid">';
    roomList.forEach(function(r){
      const items = byRoom.get(r.room_id) || [];
      const itemsToday = singleDay
        ? items.filter(function(it){ return it.date === f; })
        : [];

      html += '<div class="card">';
      html += '<h3>' + r.room_name + '</h3>';

      if(singleDay){
        html += renderTimeline(r.room_id, itemsToday, f);
      }

      html += '<div class="hint">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ' + items.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
      if(singleDay){
        html += ' - ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß';
      }
      html += '</div>';

      if(items.length){
        html +=
          '<table>' +
          '<thead><tr>' +
          '<th style="width:140px">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>' +
          '<th style="width:100px">‡πÄ‡∏ß‡∏•‡∏≤</th>' +
          '<th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th>' +
          '<th>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</th>' +
          '<th style="width:110px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>' +
          '</tr></thead><tbody>';

        html += items.map(function(it){
          return (
            '<tr>' +
              '<td>' + formatDateDMY(it.date) + '</td>' +
              '<td>' + (it.start || '-') + '-' + (it.end || '-') + '</td>' +
              '<td>' + (it.by || '-') + '</td>' +
              '<td>' + (it.purpose || '-') + '</td>' +
              '<td>' + statusBadge(it) + '</td>' +
            '</tr>'
          );
        }).join('');

        html += '</tbody></table>';
      }else{
        html += '<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</div>';
      }

      html += '</div>'; // .card
    });
    html += '</div>'; // .grid

    if(!singleDay){
      html += '<div class="hint" style="margin-top:8px">' +
              'üí° ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏´‡πá‡∏ô "‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå" ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô' +
              '</div>';
    }

    $('dashboard').innerHTML = html;
  }

  // ===== Real-time polling =====
  async function tick(force){
    // ‡πÇ‡∏ä‡∏ß‡πå‡∏ß‡πà‡∏≤ ‚Äú‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Äù ‡∏Å‡πà‡∏≠‡∏ô
    msg('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', '');
    try{
      await loadAllBookings();
      const h = itemsHash(allItems);
      if(force || h !== lastHash){
        lastHash = h;
        renderDashboard();
      }
      $('stamp').textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ' + nowStamp();
      msg('‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', 'ok');
    }catch(e){
      $('stamp').textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + String(e);
      msg('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + String(e), 'bad');
    }
  }

  function schedule(){
    if(pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(function(){ tick(false); }, POLL_SEC * 1000);
  }

  // boot
  document.addEventListener('DOMContentLoaded', async function(){
    // default date = ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Üí ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
    const today = new Date();
    $('date_from').value = toDateStr(today);
    $('date_to').value   = toDateStr(today);

    try{
      await loadRooms();
    }catch(e){
      msg('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + String(e), 'bad');
    }

    await tick(true);   // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å + ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    schedule();         // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏û‡∏•‡∏ó‡∏∏‡∏Å POLL_SEC ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

    // ‡∏õ‡∏∏‡πà‡∏° "‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ"
    $('load').onclick = function(){ tick(true); };

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á ‚Üí ‡∏î‡∏∂‡∏á‡πÉ‡∏´‡∏°‡πà + ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÇ‡∏û‡∏•
    $('room').onchange      = function(){ tick(true); schedule(); };
    $('date_from').onchange = function(){ tick(true); schedule(); };
    $('date_to').onchange   = function(){ tick(true); schedule(); };

    // ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏´‡∏ô‡πâ‡∏≤ ‚Üí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    document.addEventListener('visibilitychange', function(){
      if(!document.hidden) tick(true);
    });
  });
</script>
