<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard Meeting</title>
<link rel="icon" type="image/png" href="https://namyennn.github.io/room-booking/LOGOCS.png?v=1">
<style>
  :root{
    --card:#fff;
    --muted:#666;
    --line:#eee;
    --chip:#f6f6f6;
  }
  body{
    font-family:system-ui,Segoe UI,Arial;
    padding:16px;
    max-width:1100px;
    margin:auto;
    background:#f3f4f6; /* ‡πÉ‡∏´‡πâ‡∏ü‡∏µ‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô */
  }

  /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ */
  .page-card{
    background:#ffffff;
    border-radius:16px;
    padding:16px 20px 20px;
    box-shadow:0 10px 25px rgba(15,23,42,0.08);
    border:1px solid #e5e7eb;
  }

  /* Topbar + ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå */
  .topbar{
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-bottom:12px;
  }
  .brand{
    display:flex;
    align-items:center;
    gap:12px;
  }
  .brand-logo{
    width:44px;
    height:44px;
    border-radius:12px;
    object-fit:cover;
    border:1px solid #e5e7eb;
    background:#fff;
  }
  .brand-title{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  h1{
    margin:0;
    font-size:20px;
  }
  .brand-sub{
    font-size:12px;
    color:#64748b;
  }

  .who{font-size:13px;color:#444}

  fieldset{
    border:1px solid #ddd;
    padding:12px;
    margin:12px 0;
    border-radius:12px;
    background:#fff;
  }
  label{display:block;margin:6px 0 4px}
  input,select,button{
    padding:8px;
    border:1px solid #ccc;
    border-radius:10px;
    background:#fff;
    font:inherit;
  }
  button{cursor:pointer}
  .filters{
    display:grid;
    grid-template-columns:1fr 1fr 1fr auto; /* 4 ‡∏ä‡πà‡∏≠‡∏á */
    gap:8px;
    align-items:end;
  }
  @media(max-width:820px){
    .filters{
      grid-template-columns:1fr 1fr;
    }
  }

  .hint{font-size:12px;color:var(--muted)}
  .ok{color:#0a7}
  .bad{color:#b00020}

  details{margin-top:14px}
  pre{white-space:pre-wrap}

  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
    gap:12px;
    margin-top:12px;
  }
  .card{
    background:var(--card);
    border:1px solid #e9e9e9;
    border-radius:14px;
    padding:12px;
  }
  .card h3{margin:0 0 6px;font-size:16px}
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:8px;
  }
  th,td{
    border:1px solid var(--line);
    padding:6px 8px;
    text-align:left;
    font-size:13px;
    vertical-align:top;
  }
  th{background:#f9f9f9}
  .status-badge{
    padding:1px 8px;
    border-radius:999px;
    border:1px solid #ddd;
    font-size:11px;
  }
  .status-wait{border-color:#777;color:#777}
  .status-ongoing{border-color:#1565c0;color:#1565c0}
  .status-confirmed{border-color:#0a7;color:#0a7}
  .status-cancelled{border-color:#b00020;color:#b00020}
  .empty{
    color:#777;
    text-align:center;
    padding:12px;
    border:1px dashed #ddd;
    border-radius:8px;
    background:#fff;
  }

  /* live chip */
  .chip{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border:1px solid #ddd;
    border-radius:999px;
    background:#fff;
    font-size:12px;
  }
  .dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:#0a7;
    box-shadow:0 0 0 0 rgba(10,167,128,.5);
    animation:pulse 1.6s infinite;
  }
  .dot.paused{
    background:#bbb;
    box-shadow:none;
    animation:none;
  }
  @keyframes pulse{
    to{box-shadow:0 0 0 10px rgba(10,167,128,0)}
  }

  /* Timeline */
  .timeline-wrap{margin-top:8px}
  .timeline-head{
    display:flex;
    justify-content:space-between;
    font-size:11px;
    color:#555;
    margin:2px 2px 4px;
  }
  .timeline{
    position:relative;
    height:26px;
    border:1px solid #e5e5e5;
    border-radius:8px;
    background:#fff;
    overflow:hidden;
  }
  .tick{
    position:absolute;
    top:0;
    bottom:0;
    width:1px;
    background:#f0f0f0;
  }
  .slot{
    position:absolute;
    top:2px;
    bottom:2px;
    border-radius:6px;
    border:1px solid #cfe3ff;
    background:#eaf3ff;
    font-size:11px;
    line-height:22px;
    padding:0 6px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .slot.ongoing{
    border-color:#bcdcff;
    background:#e3f0ff;
    box-shadow:0 0 0 1px rgba(21,101,192,.08) inset;
  }
  .slot.cancelled{
    border-color:#f2c4c4;
    background:#fdeeee;
    color:#b00020;
    text-decoration:line-through;
  }
  .timeline-legend{
    font-size:11px;
    color:#666;
    margin-top:4px;
  }
</style>
</head>
<body>
<div class="page-card">
  <div class="topbar">
    <div class="brand">
      <img src="https://namyennn.github.io/room-booking/LOGOCS.png?v=1" alt="Logo" class="brand-logo">
      <div class="brand-title">
        <h1>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</h1>
        <div class="brand-sub">‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
      </div>
    </div>
    <div class="who" id="who">
      <span class="chip">
        <span class="dot" id="liveDot"></span>
        <span id="liveText">Live</span>
      </span>
      <span class="hint" id="stamp" style="margin-left:8px"></span>
    </div>
  </div>

  <fieldset class="filters">
    <div>
      <label>‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" id="date_from">
    </div>
    <div>
      <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" id="date_to">
    </div>
    <div>
      <label>‡∏´‡πâ‡∏≠‡∏á (‡∏ß‡πà‡∏≤‡∏á = ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á)</label>
      <select id="room"><option value="">(‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á)</option></select>
    </div>
    <div>
      <label>&nbsp;</label>
      <button id="load">‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>
  </fieldset>

  <div id="msg" class="hint"></div>
  <div id="dashboard"></div>

  <details><summary>DEBUG</summary><pre id="debug"></pre></details>
</div>

<script>
  // ===== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì =====
  const API = 'https://script.google.com/macros/s/AKfycbyuudinVzhjxa3Qd_i_xZc1dQIe9AJ04dL2Ahg5x4bx94cRkadWcJ8pFihXAgEfDNekOg/exec';
  const POLL_SEC = 7; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 7 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  // ======================================

  let allRooms = [];
  let allItems = [];
  let pollTimer = null;
  let lastHash = '';

  const $ = id => document.getElementById(id);
  const log = t => { const el=$('debug'); if(el) el.textContent += t+'\n'; };
  const msg = (t, cls='') => { const el=$('msg'); el.textContent=t; el.className='hint '+cls; };
  const toDateStr = d => d.toISOString().slice(0,10);
  const nowStamp = ()=> new Date().toLocaleString();

  // === helpers ===
  function formatDateDMY(dateStr){
    if(!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return '-';
    const [y,m,d] = dateStr.split('-'); return `${d} - ${m} - ${y}`;
  }
  function parseDateTimeLocal(dateStr, timeStr){
    const t = (timeStr && /^\d{2}:\d{2}$/.test(timeStr)) ? timeStr : '00:00';
    return new Date(`${dateStr}T${t}:00`);
  }
  function itemsHash(items){
    return JSON.stringify(items.map(x=>[
      x.ref,x.room_id,x.date,x.start,x.end,x.by,x.purpose,x.status
    ]).sort());
  }

  // fetch helper
  async function api(path, opt = {}){
    const url = API + path + (path.includes('?')?'&':'?') + 'v=' + Date.now();
    log('API: '+url+' method='+(opt.method||'GET'));
    const res = await fetch(url, {
      method: opt.method || 'GET',
      body: opt.body || undefined,
      mode: 'cors',
      credentials: 'omit',
      cache: 'no-store',
      redirect: 'follow',
      referrerPolicy: 'no-referrer'
    });
    const raw = await res.text().catch(()=> '');
    log('HTTP: '+res.status+' RAW: '+raw.slice(0,200));
    if(!res.ok) throw new Error('HTTP '+res.status+' '+raw.slice(0,200));
    try { return JSON.parse(raw); } catch { throw new Error('BAD JSON: '+raw.slice(0,200)); }
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á
  async function loadRooms(){
    const d = await api('?action=rooms');
    allRooms = (d.rooms||[]).map(r=>({
      room_id:r.room_id,
      room_name:r.room_name||r.room_id
    }));
    const sel = $('room');
    sel.innerHTML = '<option value="">(‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á)</option>';
    allRooms.forEach(r=>{
      const o=document.createElement('option');
      o.value=r.room_id;
      o.textContent=r.room_name;
      sel.appendChild(o);
    });
  }

  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏à‡∏≤‡∏Å calendar (‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
  async function loadAllBookings(){
    const f = $('date_from').value;
    const t = $('date_to').value;
    const roomPick = $('room').value || '';

    const path =
      '?action=calendar'
      + (roomPick ? '&room_id='+encodeURIComponent(roomPick) : '')
      + (f ? '&date_from='+f : '')
      + (t ? '&date_to='+t : '');

    const d = await api(path);
    allItems = (d.items||[]).map(x=>({
      ...x,
      status:'confirmed' // calendar ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ cancel ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ confirmed
    }));
  }

  // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  function effectiveStatus(it){
    try{
      const now = new Date();
      const s = parseDateTimeLocal(it.date, it.start);
      const e = it.end && /^\d{2}:\d{2}$/.test(it.end)
        ? parseDateTimeLocal(it.date, it.end)
        : new Date(s.getTime() + 60*60*1000);

      if (now < s) return { label:'wait', cls:'status-wait' };
      if (now >= s && now <= e) return { label:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°', cls:'status-ongoing' };
      return { label:'confirmed', cls:'status-confirmed' };
    }catch(_){
      return { label:'confirmed', cls:'status-confirmed' };
    }
  }
  const statusBadge = it => {
    const s = effectiveStatus(it);
    return `<span class="status-badge ${s.cls}">${s.label}</span>`;
  };

  // ===== Timeline (‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ single day) =====
  const TL_START = 7, TL_END = 20, TL_SPAN = (TL_END - TL_START) * 60;
  const hmToMinutes = hm => {
    const [h,m]=(hm||'00:00').split(':').map(Number);
    return h*60+m;
  };
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

  function renderTimeline(roomId, itemsForRoomOnDate, dateStr){
    let head = '<div class="timeline-head"><span>'
      + formatDateDMY(dateStr)
      + '</span><span>‡πÄ‡∏ß‡∏•‡∏≤ '
      + String(TL_START).padStart(2,'0')
      + ':00 - '
      + TL_END
      + ':00</span></div>';
    let html = '<div class="timeline">';
    for(let hr=TL_START+1; hr<=TL_END-1; hr++){
      const left = ((hr - TL_START) / (TL_END - TL_START)) * 100;
      html += `<div class="tick" style="left:${left}%"></div>`;
    }
    itemsForRoomOnDate.forEach(it=>{
      const sM = hmToMinutes(it.start||'00:00');
      const eM = hmToMinutes(it.end||'00:00') || sM+60;
      const sC = clamp(sM, TL_START*60, TL_END*60);
      const eC = clamp(eM, TL_START*60, TL_END*60);
      const leftPct  = ((sC - TL_START*60) / TL_SPAN) * 100;
      const widthPct = (Math.max(eC - sC, 10) / TL_SPAN) * 100;

      const on = effectiveStatus(it).cls === 'status-ongoing';
      html += `<div class="slot ${on?'ongoing':''}"
                  title="${it.start||'-'}-${it.end||'-'} ‚Ä¢ ${it.by||'-'}"
                  style="left:${leftPct}%;width:${widthPct}%">
                  ${it.start||'-'}-${it.end||'-'} ‚Ä¢ ${it.by||'-'}
               </div>`;
    });
    html += '</div><div class="timeline-legend">* ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</div>`;
    return '<div class="timeline-wrap">'+head+html+'</div>';
  }

  // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
  function renderDashboard(){
    const f = $('date_from').value, t = $('date_to').value, roomPick = $('room').value;
    const fromS = f || null, toS = t || null, singleDay = !!(f && t && f===t);

    const filtered = allItems.filter(it=>{
      if(roomPick && it.room_id !== roomPick) return false;
      if(fromS && it.date < fromS) return false;
      if(toS && it.date > toS) return false;
      return true;
    });

    const byRoom = new Map();
    filtered.forEach(it=>{
      if(!byRoom.has(it.room_id)) byRoom.set(it.room_id, []);
      byRoom.get(it.room_id).push(it);
    });
    for(const arr of byRoom.values()){
      arr.sort((a,b)=> a.date.localeCompare(b.date) || (a.start||'').localeCompare(b.start||''));
    }

    const roomList = (roomPick
      ? allRooms.filter(r=>byRoom.has(r.room_id))
      : allRooms.slice().sort((a,b)=> (a.room_name||'').localeCompare(b.room_name||'')));

    if(roomList.length===0){
      $('dashboard').innerHTML = `<div class="empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>`;
      return;
    }

    let html = '<div class="grid">';
    roomList.forEach(r=>{
      const items = byRoom.get(r.room_id) || [];
      const itemsToday = singleDay ? items.filter(it => it.date === f) : [];

      html += `<div class="card">
        <h3>${r.room_name}</h3>
        ${singleDay ? renderTimeline(r.room_id, itemsToday, f) : ''}
        <div class="hint">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£${singleDay ? ' ‚Ä¢ ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß' : ''}</div>
        ${items.length ? `
          <table>
            <thead><tr>
              <th style="width:140px">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th style="width:100px">‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th>
              <th>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</th>
              <th style="width:110px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            </tr></thead>
            <tbody>
              ${items.map(it=>`
                <tr>
                  <td>${formatDateDMY(it.date)}</td>
                  <td>${(it.start||'-')+'-'+(it.end||'-')}</td>
                  <td>${it.by||'-'}</td>
                  <td>${it.purpose||'-'}</td>
                  <td>${statusBadge(it)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        ` : `<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</div>`}
      </div>`;
    });
    html += '</div>';

    if(!singleDay){
      html += `<div class="hint" style="margin-top:8px">üí° ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏´‡πá‡∏ô ‚Äú‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‚Äù ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</div>`;
    }

    $('dashboard').innerHTML = html;
  }

  // ===== Real-time polling =====
  async function tick(force=false){
    try{
      await loadAllBookings();
      const h = itemsHash(allItems);
      if (force || h !== lastHash) {
        lastHash = h;
        renderDashboard();
      }
      $('stamp').textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ' + nowStamp();
      msg('‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', 'ok');
    }catch(e){
      $('stamp').textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + String(e);
      msg('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+String(e), 'bad');
    }
  }

  function schedule(){
    if(pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(()=>tick(false), POLL_SEC*1000);
  }

  // boot
  document.addEventListener('DOMContentLoaded', async ()=>{
    // default date = ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Üí ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô ‡∏ñ‡∏∂‡∏á‡∏≠‡∏µ‡∏Å 60 ‡∏ß‡∏±‡∏ô (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏à‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢)
    const today = new Date();
    const past  = new Date(); past.setDate(today.getDate()-7);
    const twoM  = new Date(); twoM.setDate(today.getDate()+60);
    $('date_from').value = toDateStr(past);
    $('date_to').value   = toDateStr(twoM);

    try{
      await loadRooms();
    }catch(e){
      msg('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+String(e), 'bad');
    }

    await tick(true);  // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å + ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    schedule();        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏û‡∏•‡∏ó‡∏∏‡∏Å POLL_SEC ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

    // ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‚Äù
    $('load').onclick = ()=> tick(true);

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á ‚Üí ‡∏î‡∏∂‡∏á‡πÉ‡∏´‡∏°‡πà + ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÇ‡∏û‡∏•
    $('room').onchange = ()=>{ tick(true); schedule(); };
    $('date_from').onchange = ()=>{ tick(true); schedule(); };
    $('date_to').onchange = ()=>{ tick(true); schedule(); };

    // ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏´‡∏ô‡πâ‡∏≤ ‚Üí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) tick(true); });
  });
</script>
</body>
</html>
