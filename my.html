<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô / ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</title>
<link rel="icon" type="image/png" href="https://namyennn.github.io/room-booking/LOGOCS.png?v=1">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --muted: #64748b;
    --primary: #2563eb; --danger: #ef4444; --border: #e2e8f0;
  }
  @media (prefers-color-scheme: dark) {
    :root { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --muted: #94a3b8; --border: #334155; }
  }
  * { box-sizing: border-box; font-family: 'IBM Plex Sans Thai', sans-serif; }
  body { background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
  .container { width: 100%; max-width: 500px; }
  .main-card { background: var(--card); border-radius: 24px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid var(--border); }
  
  .topbar { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
  .topbar img { width: 45px; height: 45px; border-radius: 10px; }
  h1 { font-size: 18px; margin: 0; }

  .card-booking { background: var(--bg); border: 1px solid var(--border); border-radius: 18px; padding: 18px; margin-bottom: 15px; position: relative; }
  .ref-tag { position: absolute; top: 0; right: 0; background: var(--primary); color: white; padding: 3px 10px; font-size: 10px; border-bottom-left-radius: 12px; font-weight: bold; }
  .room-name { font-size: 17px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
  .info-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; }
  .info-label { color: var(--muted); font-size: 12px; }
  
  .purpose-box { background: var(--card); padding: 10px; border-radius: 10px; font-size: 13px; margin: 10px 0; border: 1px solid var(--border); color: var(--muted); }

  button.danger {
    width: 100%; padding: 12px; background: #fff1f2; color: var(--danger);
    border: 1px solid #fecdd3; border-radius: 12px; font-weight: 600; cursor: pointer;
  }
  button.danger:active { background: var(--danger); color: white; }

  .empty-state { text-align: center; padding: 50px 20px; color: var(--muted); }
  #msg { text-align: center; font-size: 14px; margin-top: 15px; min-height: 20px; }
  .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="container">
  <div class="main-card">
    <div class="topbar">
      <img src="https://namyennn.github.io/room-booking/LOGOCS.png?v=1" alt="Logo">
      <div>
        <h1>‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h1>
        <div style="font-size: 12px; color: var(--muted);" id="user-display">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô LINE...</div>
      </div>
    </div>

    <div id="list">
      <div class="empty-state">
        <div class="loader"></div>
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
      </div>
    </div>

    <p id="msg"></p>

    <div style="text-align: center; margin-top: 15px;">
      <a href="booking.html" style="color: var(--primary); text-decoration: none; font-size: 14px; font-weight: 600;">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÉ‡∏ä‡πâ API URL ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
  const API = 'https://script.google.com/macros/s/AKfycbyuudinVzhjxa3Qd_i_xZc1dQIe9AJ04dL2Ahg5x4bx94cRkadWcJ8pFihXAgEfDNekOg/exec';
  const LIFF_ID = '2008386695-b1ykgdPk';

  let lineUserId = '';
  const $ = id => document.getElementById(id);

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
  async function fetchMyBookings() {
    try {
      const res = await fetch(`${API}?action=my_bookings&line_user=${lineUserId}&v=${Date.now()}`);
      const data = await res.json();
      renderList(data.items || []);
    } catch (e) {
      $('list').innerHTML = '<div class="empty-state">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>';
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
  function renderList(items) {
    const box = $('list');
    if (items.length === 0) {
      box.innerHTML = '<div class="empty-state">üìÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>';
      return;
    }
    box.innerHTML = '';
    items.forEach(it => {
      box.innerHTML += `
        <div class="card-booking">
          <div class="ref-tag">REF: ${it.ref}</div>
          <div class="room-name">üè¢ ${it.room_id}</div>
          <div class="info-row">
            <span class="info-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span>
            <span><b>${it.date}</b></span>
          </div>
          <div class="info-row">
            <span class="info-label">‡πÄ‡∏ß‡∏•‡∏≤:</span>
            <span><b>${it.start} - ${it.end}</b></span>
          </div>
          <div class="purpose-box">${it.purpose || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå'}</div>
          <button class="danger" onclick="cancelBooking('${it.ref}')">üóëÔ∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
        </div>
      `;
    });
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
  async function cancelBooking(ref) {
    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${ref}?`)) return;
    
    $('msg').innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';
    try {
      const form = new URLSearchParams();
      form.set('payload', JSON.stringify({ action: 'cancel', ref: ref, line_user: lineUserId }));
      const res = await fetch(API, { method: 'POST', body: form });
      const result = await res.json();
      
      if (result.ok) {
        $('msg').innerHTML = '<span style="color:var(--primary)">‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>';
        fetchMyBookings();
      } else {
        $('msg').innerHTML = `<span style="color:var(--danger)">‚ùå ${result.reason || '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}</span>`;
      }
    } catch (e) {
      $('msg').innerHTML = '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF
  async function main() {
    try {
      await liff.init({ liffId: LIFF_ID });
      
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÉ‡∏ô LINE (‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login) ‡πÉ‡∏´‡πâ Login ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      if (!liff.isLoggedIn()) {
        liff.login();
      } else {
        const profile = await liff.getProfile();
        lineUserId = profile.userId;
        $('user-display').textContent = `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${profile.displayName}`;
        fetchMyBookings(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏π‡πâ ID
      }
    } catch (err) {
      $('list').innerHTML = '<div class="empty-state">‚ö†Ô∏è LIFF Error: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å LINE</div>';
    }
  }

  main();
</script>
</body>
</html>
