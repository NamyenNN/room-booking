<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>การจองของฉัน / ยกเลิก</title>
<style>
  body{
    font-family:system-ui,Segoe UI,Arial;
    padding:16px;
    max-width:720px;
    margin:auto;
    background:#f3f4f6; /* พื้นหลังเทาอ่อน ให้ฟีลเหมือนหน้าเว็บจอง */
  }
  .card{
    border:1px solid #e5e7eb;
    border-radius:16px;
    padding:16px 20px 20px;
    margin:10px 0;
    background:#ffffff;
    box-shadow:0 10px 25px rgba(15,23,42,0.08);
  }
  .topbar{
    display:flex;
    gap:12px;
    align-items:center;
    margin-bottom:12px;
  }
  .brand-logo{
    width:44px;
    height:44px;
    border-radius:12px;
    object-fit:cover;
    border:1px solid #e5e7eb;
    background:#fff;
  }
  .brand-title{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  h1{
    margin:0;
    font-size:20px;
  }
  .brand-sub{
    font-size:12px;
    color:#64748b;
  }

  .card-booking{
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:12px;
    margin:10px 0;
    background:#f9fafb;
  }
  .row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
  }
  @media(max-width:600px){
    .row{
      grid-template-columns:1fr;
    }
  }
  button{
    padding:10px;
    border:1px solid #ccc;
    border-radius:8px;
    width:100%;
    font:inherit;
    cursor:pointer;
    background:#ffffff;
  }
  button.danger{
    border-color:#b00020;
    color:#b00020;
  }
  .hint{
    font-size:12px;
    color:#666;
  }
  #msg{
    margin-top:4px;
  }
  details{
    margin-top:14px;
    font-size:12px;
  }
  pre{
    white-space:pre-wrap;
  }
</style>
<link rel="icon" type="image/png" href="https://namyennn.github.io/room-booking/LOGOCS.png?v=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<div class="card">
  <div class="topbar">
    <img src="https://namyennn.github.io/room-booking/LOGOCS.png?v=1" alt="Logo" class="brand-logo">
    <div class="brand-title">
      <h1>การจองของฉัน / ยกเลิก</h1>
      <div class="brand-sub">ดูสถานะการจอง และยกเลิกการจองที่ยังไม่หมดเวลา</div>
    </div>
  </div>

  <p class="hint">รายการด้านล่างคือการจองที่สถานะยังไม่ถูกยกเลิก</p>

  <div id="list"></div>
  <p id="msg" class="hint"></p>

  <details>
    <summary>DEBUG</summary>
    <pre id="debug"></pre>
  </details>
</div>

<script>
  // ===== ตั้งค่าของคุณ (ต้องตรงกับ booking.html) =====
  const API = 'https://script.google.com/macros/s/AKfycbyuudinVzhjxa3Qd_i_xZc1dQIe9AJ04dL2Ahg5x4bx94cRkadWcJ8pFihXAgEfDNekOg/exec';
  const LIFF_ID = '2008386695-b1ykgdPk';
  // =====================================================

  let lineUserId = '';
  const $ = id => document.getElementById(id);
  const log = t => { const el=$('debug'); if(el) el.textContent += t+'\n'; };

  async function api(path, opt={}){
    const url = API + path + (path.includes('?')?'&':'?') + 'v=' + Date.now();
    log('API: '+url+' method='+(opt.method||'GET'));
    const res = await fetch(url, {
      method: opt.method || 'GET',
      body: opt.body || undefined, // อย่าตั้ง header เองเวลา POST
      mode: 'cors', credentials: 'omit', cache: 'no-store',
      redirect: 'follow', referrerPolicy: 'no-referrer'
    });
    const raw = await res.text().catch(()=> '');
    log('HTTP: '+res.status+' RAW: '+raw.slice(0,120));
    if(!res.ok) throw new Error('HTTP '+res.status+' '+raw.slice(0,200));
    try { return JSON.parse(raw); } catch { throw new Error('BAD JSON: '+raw.slice(0,200)); }
  }

  async function initLIFFRequire(){
    await liff.init({ liffId: LIFF_ID });
    if(!liff.isLoggedIn()){
      liff.login({ redirectUri: location.href });
      return;
    }
    const p = await liff.getProfile();
    lineUserId = p.userId || '';
    log('LIFF OK user='+lineUserId);
  }

  async function loadMy(){
    const box = $('list');
    box.innerHTML = 'กำลังโหลด...';
    try{
      const d = await api(`?action=my_bookings&line_user=${encodeURIComponent(lineUserId)}`);
      const items = (d && d.items) || [];
      if(items.length===0){
        box.innerHTML='(ยังไม่มีการจองที่ใช้งานอยู่)';
        return;
      }
      box.innerHTML='';
      items.forEach(it=>{
        const div = document.createElement('div');
        div.className='card-booking';
        div.innerHTML = `
          <div><b>Ref:</b> ${it.ref}</div>
          <div class="row">
            <div><b>ห้อง:</b> ${it.room_id}</div>
            <div><b>วันที่:</b> ${it.date}</div>
          </div>
          <div class="row">
            <div><b>เวลา:</b> ${it.start}-${it.end}</div>
            <div><b>ผู้จอง:</b> ${it.by||'-'}</div>
          </div>
          <div><b>วัตถุประสงค์:</b> ${it.purpose||'-'}</div>
          <div style="margin-top:8px">
            <button class="danger" data-ref="${it.ref}">ยกเลิกการจองนี้</button>
          </div>
        `;
        box.appendChild(div);
      });
      // bind ปุ่มยกเลิก
      box.querySelectorAll('button.danger').forEach(btn=>{
        btn.onclick = ()=> cancelRef(btn.getAttribute('data-ref'));
      });
    }catch(e){
      $('msg').textContent = '❌ โหลดรายการไม่สำเร็จ: '+String(e);
    }
  }

  async function cancelRef(ref){
    if(!ref) return;
    if(!confirm('ต้องการยกเลิก Ref: '+ref+' ?')) return;
    $('msg').textContent = 'กำลังยกเลิก...';
    try{
      // ส่งแบบ form-urlencoded → เลี่ยง preflight
      const form = new URLSearchParams();
      form.set('payload', JSON.stringify({ action:'cancel', ref, line_user: lineUserId }));
      const res = await api('', { method:'POST', body: form });
      if(res.ok){
        $('msg').textContent = '✅ ยกเลิกเรียบร้อย';
        await loadMy(); // refresh รายการ
      }else{
        $('msg').textContent = '❌ ยกเลิกไม่สำเร็จ: ' + (res.reason || res.error || 'unknown');
      }
    }catch(e){
      $('msg').textContent = '❌ ยกเลิกไม่สำเร็จ: ' + String(e);
    }
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    await initLIFFRequire();
    await loadMy();
  });
</script>
</body>
</html>
