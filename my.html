<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô / ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å | ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</title>
<link rel="icon" type="image/png" href="https://namyennn.github.io/room-booking/LOGOCS.png?v=1">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  /* ============== DESIGN TOKENS ============== */
  :root {
    --bg: #f8fafc;
    --card-bg: #ffffff;
    --text-main: #1e293b;
    --text-muted: #64748b;
    --primary: #2563eb;
    --danger: #ef4444;
    --border: #e2e8f0;
    --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
  }

  /* ============== BASE ============== */
  * { box-sizing: border-box; transition: all 0.2s ease; }
  body {
    font-family: 'IBM Plex Sans Thai', sans-serif;
    background-color: var(--bg);
    color: var(--text-main);
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
    line-height: 1.6;
  }

  .container { width: 100%; max-width: 600px; animation: fadeIn 0.5s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .main-card {
    background: var(--card-bg);
    border-radius: 24px;
    padding: 25px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }

  /* ============== TOPBAR ============== */
  .topbar {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }
  .brand-logo { width: 48px; height: 48px; border-radius: 12px; }
  .brand-title h1 { margin: 0; font-size: 20px; font-weight: 700; color: var(--text-main); }
  .brand-sub { font-size: 13px; color: var(--text-muted); }

  /* ============== LIST & CARDS ============== */
  .card-booking {
    position: relative;
    background: #ffffff;
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 15px;
    overflow: hidden;
  }
  .card-booking:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1); }
  
  .ref-tag {
    position: absolute;
    top: 0;
    right: 0;
    background: #f1f5f9;
    padding: 4px 12px;
    font-size: 11px;
    font-weight: 700;
    color: var(--primary);
    border-bottom-left-radius: 12px;
    text-transform: uppercase;
  }

  .room-name { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 10px; }
  
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
  .info-item { font-size: 14px; color: var(--text-main); }
  .info-label { display: block; font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }

  .purpose-box {
    background: #f8fafc;
    padding: 10px 14px;
    border-radius: 12px;
    font-size: 14px;
    margin-bottom: 15px;
    border-left: 3px solid #cbd5e1;
  }

  /* ============== BUTTONS ============== */
  button.danger {
    width: 100%;
    padding: 12px;
    background: #fff1f2;
    color: var(--danger);
    border: 1px solid #fecdd3;
    border-radius: 14px;
    font-family: inherit;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  button.danger:hover { background: var(--danger); color: white; border-color: var(--danger); }

  /* ============== OTHERS ============== */
  .hint { font-size: 13px; color: var(--text-muted); text-align: center; margin-bottom: 20px; }
  #msg { margin-top: 15px; text-align: center; font-weight: 500; font-size: 14px; }
  
  .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
  .empty-state-icon { font-size: 48px; margin-bottom: 10px; display: block; opacity: 0.5; }

  details { margin-top: 30px; opacity: 0.4; font-size: 11px; }
  pre { white-space: pre-wrap; background: #eee; padding: 10px; border-radius: 8px; }
</style>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<div class="container">
  <div class="main-card">
    
    <div class="topbar">
      <img src="https://namyennn.github.io/room-booking/LOGOCS.png?v=1" alt="Logo" class="brand-logo">
      <div class="brand-title">
        <h1>‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô / ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</h1>
        <div class="brand-sub">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô LINE</div>
      </div>
    </div>

    <p class="hint">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>

    <div id="list">
      <div class="empty-state">
        <span class="empty-state-icon">‚è≥</span>
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...
      </div>
    </div>

    <p id="msg"></p>

    <div style="text-align: center; margin-top: 10px;">
        <a href="booking.html" style="text-decoration: none; font-size: 14px; color: var(--primary); font-weight: 500;">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</a>
    </div>

    <details>
      <summary>DEBUG CONSOLE</summary>
      <pre id="debug"></pre>
    </details>
  </div>
</div>

<script>
  // ===== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° (API ‡πÅ‡∏•‡∏∞ LIFF_ID ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) =====
  const API = 'https://script.google.com/macros/s/AKfycbyuudinVzhjxa3Qd_i_xZc1dQIe9AJ04dL2Ahg5x4bx94cRkadWcJ8pFihXAgEfDNekOg/exec';
  const LIFF_ID = '2008386695-b1ykgdPk';

  let lineUserId = '';
  const $ = id => document.getElementById(id);
  const log = t => { const el=$('debug'); if(el) el.textContent += t+'\n'; };

  async function api(path, opt={}){
    const url = API + path + (path.includes('?')?'&':'?') + 'v=' + Date.now();
    const res = await fetch(url, {
      method: opt.method || 'GET',
      body: opt.body || undefined,
      mode: 'cors'
    });
    const raw = await res.text().catch(()=> '');
    if(!res.ok) throw new Error('Network response was not ok');
    try { return JSON.parse(raw); } catch { throw new Error('Invalid JSON response'); }
  }

  async function initLIFFRequire(){
    try {
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()){
        liff.login({ redirectUri: location.href });
        return;
      }
      const p = await liff.getProfile();
      lineUserId = p.userId || '';
    } catch (err) {
      log('LIFF Error: ' + err);
      $('msg').textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE ‡πÑ‡∏î‡πâ';
    }
  }

  async function loadMy(){
    const box = $('list');
    try{
      const d = await api(`?action=my_bookings&line_user=${encodeURIComponent(lineUserId)}`);
      const items = (d && d.items) || [];
      
      if(items.length===0){
        box.innerHTML=`
          <div class="empty-state">
            <span class="empty-state-icon">üìÇ</span>
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà
          </div>`;
        return;
      }

      box.innerHTML='';
      items.forEach(it=>{
        const div = document.createElement('div');
        div.className='card-booking';
        div.innerHTML = `
          <div class="ref-tag">Ref: ${it.ref}</div>
          <div class="room-name">üè¢ ${it.room_id}</div>
          
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
              <b>üìÖ ${it.date}</b>
            </div>
            <div class="info-item">
              <span class="info-label">‡πÄ‡∏ß‡∏•‡∏≤</span>
              <b>‚è∞ ${it.start} - ${it.end}</b>
            </div>
          </div>
          
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</span>
              ${it.by||'-'}
            </div>
          </div>

          <div class="info-label">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</div>
          <div class="purpose-box">${it.purpose||'-'}</div>

          <button class="danger" data-ref="${it.ref}">
            <span>üóëÔ∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ</span>
          </button>
        `;
        box.appendChild(div);
      });

      box.querySelectorAll('button.danger').forEach(btn=>{
        btn.onclick = ()=> cancelRef(btn.getAttribute('data-ref'));
      });
    }catch(e){
      $('msg').innerHTML = '<span style="color:var(--danger)">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</span>';
      log('Load Error: ' + e);
    }
  }

  async function cancelRef(ref){
    if(!ref) return;
    if(!confirm('üö® ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™ ' + ref + ' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
    
    const msgEl = $('msg');
    msgEl.innerHTML = '<span style="color:var(--primary)">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å...</span>';
    
    try{
      const form = new URLSearchParams();
      form.set('payload', JSON.stringify({ action:'cancel', ref, line_user: lineUserId }));
      const res = await api('', { method:'POST', body: form });
      
      if(res.ok){
        msgEl.innerHTML = '<span style="color:var(--primary)">‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>';
        await loadMy(); 
      }else{
        msgEl.innerHTML = '<span style="color:var(--danger)">‚ùå ' + (res.reason || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î') + '</span>';
      }
    }catch(e){
      msgEl.innerHTML = '<span style="color:var(--danger)">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>';
    }
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    await initLIFFRequire();
    if(lineUserId) await loadMy();
  });
</script>
</body>
</html>
