<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="preconnect" href="https://script.google.com" crossorigin>
<link rel="dns-prefetch" href="https://script.google.com">
<link rel="preconnect" href="https://static.line-scdn.net" crossorigin>
<link rel="dns-prefetch" href="https://static.line-scdn.net">
<title>จองห้องประชุม</title>
<link rel="icon" type="image/png" href="logo-cs.png">
<style>
  body{font-family:system-ui,Segoe UI,Arial;padding:16px;max-width:720px;margin:auto;background:#fafafa}
  fieldset{border:1px solid #ddd;padding:12px;margin-bottom:16px;border-radius:12px;background:#fff}
  label{display:block;margin:8px 0 4px}
  input,select,button,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .hint{font-size:12px;color:#666}
  details{margin-top:14px}
  pre{white-space:pre-wrap}

  /* Brand (โลโก้มุมซ้าย) */
  .brand{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .brand img{height:50px;width:auto;display:block}
  .brand h1{margin:0;font-size:28px;line-height:1.1}

  /* Popup */
  #popup { position: fixed; inset: 0; display: none; }
  #popup.show { display: block; }
  #popup-backdrop{ position: absolute; inset:0; background: rgba(0,0,0,.35); }
  #popup-card{
    position: absolute; left:50%; top:50%; transform: translate(-50%,-50%);
    background:#fff; border-radius:14px; padding:18px; width:min(360px,90vw);
    box-shadow: 0 10px 30px rgba(0,0,0,.2); border:1px solid #eee;
  }
  #popup-card h3{ margin:0 0 8px }
  #popup-card p{ margin:0 0 14px; color:#444 }
  #popup-card button{
    width:100%; padding:10px 14px; border:1px solid #ccc;border-radius:10px;cursor:pointer;
    background:#f6f6f6;
  }

  /* Dashboard */
  .dash{margin-top:20px}
  .dash h2{margin:0 0 10px}
  .grid4{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (min-width:900px){.grid4{grid-template-columns:repeat(4,1fr)}}
  .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px}
  .card h3{margin:0 0 6px;font-size:16px}
  .card .count{font-size:12px;color:#666;margin-bottom:8px}
  .item{font-size:13px;border-top:1px dashed #eee;padding:6px 0}
  .muted{color:#666;font-size:12px}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<!-- โลโก้มุมซ้าย + หัวข้อ -->
<header class="brand">
  <!-- ถ้าไฟล์คุณชื่อ IMG_0154.png ให้เปลี่ยน src เป็น IMG_0154.png -->
  <a href="booking.html" aria-label="หน้าแรกการจอง">
    <img src="logo-cs.png" alt="โลโก้ CS">
  </a>
  <h1>จองห้องประชุม</h1>
</header>

<fieldset>
  <legend>เลือกห้องและวันเวลา</legend>
  <label>ห้อง</label>
  <select id="room"><option value="">(กำลังโหลด...)</option></select>
  <div class="row">
    <div><label>วันที่</label><input type="date" id="date"></div>
  </div>
  <div class="row">
    <div><label>เวลาเริ่ม</label><input type="time" id="start"></div>
    <div><label>เวลาสิ้นสุด</label><input type="time" id="end"></div>
  </div>
</fieldset>

<!-- Dashboard -->
<section id="dash" class="dash">
  <h2>รายการที่จองแล้ว (ตามห้อง/วันที่เลือก)</h2>
  <div class="grid4">
    <div class="card">
      <h3>เช้า (06:00–11:59)</h3><div id="c-morning" class="count">0 รายการ</div><div id="l-morning" class="muted">— ว่าง —</div>
    </div>
    <div class="card">
      <h3>เที่ยง–บ่ายต้น (12:00–14:59)</h3><div id="c-noon" class="count">0 รายการ</div><div id="l-noon" class="muted">— ว่าง —</div>
    </div>
    <div class="card">
      <h3>บ่าย–เย็น (15:00–18:59)</h3><div id="c-evening" class="count">0 รายการ</div><div id="l-evening" class="muted">— ว่าง —</div>
    </div>
    <div class="card">
      <h3>ค่ำ (19:00–23:59)</h3><div id="c-night" class="count">0 รายการ</div><div id="l-night" class="muted">— ว่าง —</div>
    </div>
  </div>
  <p class="muted">แสดงเฉพาะห้องและวันที่ที่เลือก • อัปเดตอัตโนมัติทุก 15 วินาที</p>
</section>

<fieldset>
  <legend>ข้อมูลผู้จอง</legend>
  <label>ชื่อผู้จอง</label><input id="by" placeholder="จะเติมจาก LINE ให้อัตโนมัติ">
  <label>วัตถุประสงค์</label><textarea id="purpose" rows="2" placeholder="เช่น ประชุมโครงการ..."></textarea>
</fieldset>

<button id="book">ยืนยันการจอง</button>
<p id="msg" class="hint"></p>
<p><a href="my.html">ไปที่ “การจองของฉัน / ยกเลิก”</a></p>

<details><summary>DEBUG</summary><pre id="debug"></pre></details>

<!-- Popup -->
<div id="popup">
  <div id="popup-backdrop"></div>
  <div id="popup-card">
    <h3 id="popup-title">ไม่สามารถจองได้</h3>
    <p id="popup-msg">ช่วงเวลานี้ถูกจองแล้ว กรุณาเลือกเวลาอื่น</p>
    <button id="popup-ok">OK</button>
  </div>
</div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbyuudinVzhjxa3Qd_i_xZc1dQIe9AJ04dL2Ahg5x4bx94cRkadWcJ8pFihXAgEfDNekOg/exec';
const LIFF_ID = '2008386695-b1ykgdPk';

let lineUserId = '';
let refreshTimer = null;
const REFRESH_MS = 15000;

const $ = (id)=>document.getElementById(id);
const log = (t)=>{ try{ if(new URLSearchParams(location.search).get('debug')!=='1') return; }catch(_){} const el=$('debug'); if(el) el.textContent += t+'\n'; };

function showPopup(msg){$('popup-msg').textContent=msg;$('popup').classList.add('show');}
function hidePopup(){$('popup').classList.remove('show');}
document.addEventListener('click',e=>{if(['popup-ok','popup-backdrop'].includes(e.target.id))hidePopup();});

async function api(path,opt={}){
  const method=(opt.method||'GET').toUpperCase();
  const bust=(method==='GET' && !opt.nobust) ? '' : (path.includes('?')?'&':'?')+'v='+Date.now();
  const url=API+path+bust;
  const ctrl=new AbortController();const timer=setTimeout(()=>ctrl.abort(),8000);
  const res=await fetch(url,{method,body:opt.body||undefined,mode:'cors',cache:'no-store',signal:ctrl.signal});
  clearTimeout(timer);
  const txt=await res.text();log('HTTP '+res.status+': '+txt.slice(0,120));
  if(!res.ok)throw new Error(txt);
  return JSON.parse(txt);
}

async function cachedJSON(key,fetcher,ttl){
  try{
    const now=Date.now();const hit=localStorage.getItem(key);
    if(hit){const o=JSON.parse(hit);if(o.t+ttl>now)return o.data;}
    const d=await fetcher();localStorage.setItem(key,JSON.stringify({t:Date.now(),data:d}));return d;
  }catch(e){return fetcher();}
}

// Dashboard
function renderDash(booked){
  const buckets={morning:[],noon:[],evening:[],night:[]};
  (booked||[]).forEach(b=>{
    const h=parseInt((b.start||'00:00').split(':')[0],10);
    if(h>=6&&h<12)buckets.morning.push(b);
    else if(h>=12&&h<15)buckets.noon.push(b);
    else if(h>=15&&h<19)buckets.evening.push(b);
    else if(h>=19)buckets.night.push(b);
  });
  const fill=(key,c,l)=>{
    const arr=buckets[key];$(c).textContent=(arr.length||0)+' รายการ';const box=$(l);
    box.innerHTML='';
    if(!arr.length){ box.innerHTML='<div class="muted">— ว่าง —</div>'; return; }
    arr.sort((a,b)=>(a.start||'').localeCompare(b.start||''));arr.forEach(x=>{
      const d=document.createElement('div');d.className='item';
      d.textContent=`[${x.start}-${x.end}] ${x.by||x.purpose||''}`;box.appendChild(d);
    });
  };
  fill('morning','c-morning','l-morning');
  fill('noon','c-noon','l-noon');
  fill('evening','c-evening','l-evening');
  fill('night','c-night','l-night');
}

// Date/time
const pad=n=>String(n).padStart(2,'0');
function setDefaultDateAndTime(){
  const now=new Date();const today=now.toISOString().slice(0,10);
  $('date').value=today;$('date').min=today;
  let h=now.getHours(),m=now.getMinutes();
  if(m>0&&m<=30)m=30; else if(m>30){m=0;h=(h+1)%24;}
  $('start').value=`${pad(h)}:${pad(m)}`;$('end').value=`${pad((h+1)%24)}:${pad(m)}`;
}
function autoAdjustEnd(){const s=$('start').value;if(!s)return;const [h,m]=s.split(':').map(Number);$('end').value=`${pad((h+1)%24)}:${pad(m)}`;}

// LIFF relaxed
async function initLIFF(){
  try{
    await liff.init({liffId:LIFF_ID});
    if(liff.isLoggedIn()){
      const p=await liff.getProfile();lineUserId=p.userId;$('by').value=p.displayName||'';
    }else{lineUserId='GUEST-'+Math.random().toString(36).slice(2,8);}
  }catch(e){lineUserId='GUEST-'+Math.random().toString(36).slice(2,8);}
}

// load rooms (เลือกห้องแรกอัตโนมัติ และเรียก dashboard ให้เอง)
async function loadRoomsAndInitDash(){
  const sel=$('room');
  try{
    const d=await cachedJSON('rooms',()=>api('?action=rooms'),120000); // แคช 2 นาที
    const rooms=(d.rooms||[]);
    sel.innerHTML='';
    rooms.forEach(r=>{
      const o=document.createElement('option');
      o.value=r.room_id;
      o.textContent=r.room_name||r.name||r.room_id;
      sel.appendChild(o);
    });
    if(!sel.value && rooms.length){ sel.value = rooms[0].room_id; }
    await checkSlots(); // ครั้งแรก
    startAutoRefresh(); // เริ่มรีเฟรชอัตโนมัติ
  }catch(e){
    sel.innerHTML='<option value="">(โหลดห้องไม่สำเร็จ)</option>';
    log('rooms error: '+e.message);
  }
}

// check slots (อัปเดต dashboard) — บังคับ fresh ทุกครั้งด้วยตัวแปรเวลา
async function checkSlots(){
  const r=$('room').value,dt=$('date').value;
  if(!r||!dt){ return; }
  const url = `?action=slots&room_id=${encodeURIComponent(r)}&date=${encodeURIComponent(dt)}&t=${Date.now()}`;
  const d=await api(url,{nobust:false});      // GET พร้อม &t=… เพื่อกันแคชเสมอ
  const booked = (d && d.booked) ? d.booked : [];
  renderDash(booked);
}

// ตั้ง timer รีเฟรช dashboard
function startAutoRefresh(){
  stopAutoRefresh();
  refreshTimer = setInterval(checkSlots, REFRESH_MS);
}
function stopAutoRefresh(){
  if(refreshTimer){ clearInterval(refreshTimer); refreshTimer=null; }
}

// book
async function book(){
  const p={room_id:$('room').value,date:$('date').value,start:$('start').value,end:$('end').value,book_by:$('by').value,purpose:$('purpose').value,line_user:lineUserId};
  const msg=$('msg');
  if(!p.room_id||!p.date||!p.start||!p.end){msg.textContent='❌ กรอกข้อมูลให้ครบ';return;}
  if(p.end<=p.start){showPopup('ช่วงเวลาสิ้นสุดต้องช้ากว่าเวลาเริ่ม');return;}
  msg.textContent='กำลังบันทึก...';
  try{
    const form=new URLSearchParams();form.set('payload',JSON.stringify(p));
    const res=await api('',{method:'POST',body:form});
    if(!res.ok){
      const err=(res.error||res.reason||'').toUpperCase();
      if(err.includes('TIME_CONFLICT')){showPopup('ช่วงเวลานี้ถูกจองแล้ว');msg.textContent='❌ เวลาซ้ำ';return;}
      showPopup('จองไม่สำเร็จ: '+(res.error||res.reason||'เกิดข้อผิดพลาด'));msg.textContent='❌ ไม่สำเร็จ';return;
    }
    msg.textContent='✅ จองสำเร็จ! Ref: '+(res.ref||'');
    await checkSlots(); // รีเฟรช dashboard ทันที
  }catch(e){showPopup('เครือข่ายขัดข้อง');msg.textContent='❌ ไม่สำเร็จ: '+e.message;}
}

document.addEventListener('visibilitychange',()=>{
  if(document.hidden) stopAutoRefresh();
  else startAutoRefresh();
});

document.addEventListener('DOMContentLoaded',async()=>{
  setDefaultDateAndTime();
  await initLIFF();
  await loadRoomsAndInitDash();

  // เปลี่ยนห้อง/วันที่ → รีเฟรชทันที + รีสตาร์ท interval
  $('room').addEventListener('change', ()=>{ checkSlots(); startAutoRefresh(); });
  $('date').addEventListener('change', ()=>{ checkSlots(); startAutoRefresh(); });

  $('start').addEventListener('change', autoAdjustEnd);
  $('book').onclick=book;
});
</script>
</body>
</html>
