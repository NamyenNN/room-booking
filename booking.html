<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="preconnect" href="https://script.google.com" crossorigin>
<link rel="dns-prefetch" href="https://script.google.com">
<link rel="preconnect" href="https://static.line-scdn.net" crossorigin>
<link rel="dns-prefetch" href="https://static.line-scdn.net">
<title>จองห้องประชุม</title>
<link rel="icon" type="image/png" href="https://namyennn.github.io/room-booking/LOGOCS.png?v=1">
<style>
  body{font-family:system-ui,Segoe UI,Arial;padding:16px;max-width:720px;margin:auto;background:#fafafa}
  fieldset{border:1px solid #ddd;padding:12px;margin-bottom:16px;border-radius:12px;background:#fff}
  label{display:block;margin:6px 0 4px}
  input,select,button,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .hint{font-size:12px;color:#666}
  details{margin-top:14px}
  pre{white-space:pre-wrap}

  /* โลโก้มุมซ้าย */
  .brand{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .brand img{height:50px;width:auto;display:block}
  .brand h1{margin:0;font-size:28px;line-height:1.1}

  /* Dashboard */
  .dash{margin-top:20px}
  .dash h2{margin:0 0 10px}
  .grid4{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (min-width:900px){.grid4{grid-template-columns:repeat(4,1fr)}}
  .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px}
  .card h3{margin:0 0 6px;font-size:16px}
  .card .count{font-size:12px;color:#666;margin-bottom:8px}
  .item{font-size:13px;border-top:1px dashed #eee;padding:6px 0}
  .muted{color:#666;font-size:12px}

  /* ช่องเวลา (คอมแพ็ค) */
  .time-row {display:flex;justify-content:space-between;gap:12px;}
  .time-group {display:flex;align-items:center;gap:6px;flex:1;}
  .time-group label {margin:0;}
  #start,#end {width:100%;max-width:120px;padding:6px;font-size:14px;}

  /* Popup */
  #popup { position: fixed; inset: 0; display: none; }
  #popup.show { display: block; }
  #popup-backdrop{ position: absolute; inset:0; background: rgba(0,0,0,.35); }
  #popup-card{
    position: absolute; left:50%; top:50%; transform: translate(-50%,-50%);
    background:#fff; border-radius:14px; padding:18px; width:min(360px,90vw);
    box-shadow: 0 10px 30px rgba(0,0,0,.2); border:1px solid #eee;
  }
  #popup-card h3{ margin:0 0 8px }
  #popup-card p{ margin:0 0 14px; color:#444 }
  #popup-card button{
    width:100%; padding:10px 14px; border:1px solid #ccc;border-radius:10px;cursor:pointer;
    background:#f6f6f6;
  }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<header class="brand">
  <a href="booking.html" aria-label="หน้าแรกการจอง">
    <img src="https://namyennn.github.io/room-booking/LOGOCS.png?v=1" alt="LOGO">
  </a>
  <h1>จองห้องประชุม</h1>
</header>

<fieldset>
  <legend>เลือกห้องและวันเวลา</legend>
  <label>ห้อง</label>
  <select id="room"></select> <!-- เอา option (กำลังโหลด...) ออก -->

  <div class="row" style="margin-top:8px">
    <div><label>วันที่</label><input type="date" id="date"></div>
  </div>
  <div class="time-row">
    <div class="time-group"><label>เวลาเริ่ม</label><input type="time" id="start"></div>
    <div class="time-group"><label>เวลาสิ้นสุด</label><input type="time" id="end"></div>
  </div>
</fieldset>

<section id="dash" class="dash">
  <h2>รายการที่จองแล้ว (ตามห้อง/วันที่เลือก)</h2>
  <div class="grid4">
    <div class="card"><h3>เช้า (06:00–11:59)</h3><div id="c-morning" class="count">0 รายการ</div><div id="l-morning" class="muted">— ว่าง —</div></div>
    <div class="card"><h3>เที่ยง–บ่ายต้น (12:00–14:59)</h3><div id="c-noon" class="count">0 รายการ</div><div id="l-noon" class="muted">— ว่าง —</div></div>
    <div class="card"><h3>บ่าย–เย็น (15:00–18:59)</h3><div id="c-evening" class="count">0 รายการ</div><div id="l-evening" class="muted">— ว่าง —</div></div>
    <div class="card"><h3>ค่ำ (19:00–23:59)</h3><div id="c-night" class="count">0 รายการ</div><div id="l-night" class="muted">— ว่าง —</div></div>
  </div>
</section>

<fieldset>
  <legend>ข้อมูลผู้จอง</legend>
  <label>ชื่อผู้จอง</label><input id="by" placeholder="จะเติมจาก LINE ให้อัตโนมัติ">
  <label>วัตถุประสงค์</label><textarea id="purpose" rows="2" placeholder="เช่น ประชุมโครงการ..."></textarea>
</fieldset>

<button id="book">ยืนยันการจอง</button>
<p id="msg" class="hint"></p>
<p><a href="my.html">ไปที่ “การจองของฉัน / ยกเลิก”</a></p>

<details><summary>DEBUG</summary><pre id="debug"></pre></details>

<!-- Popup -->
<div id="popup" role="dialog" aria-modal="true" aria-labelledby="popup-title">
  <div id="popup-backdrop"></div>
  <div id="popup-card">
    <h3 id="popup-title">ไม่สามารถจองได้</h3>
    <p id="popup-msg">ช่วงเวลานี้ถูกจองแล้ว กรุณาเลือกเวลาอื่น</p>
    <button id="popup-ok" type="button">OK</button>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API = 'https://script.google.com/macros/s/AKfycbyuudinVzhjxa3Qd_i_xZc1dQIe9AJ04dL2Ahg5x4bx94cRkadWcJ8pFihXAgEfDNekOg/exec';
const LIFF_ID = '2008386695-b1ykgdPk';
const REFRESH_MS = 15000;

/* ===== Helpers ===== */
const $ = (id) => document.getElementById(id);
const pad = (n) => String(n).padStart(2,'0');
const popup = {
  show(msg){ $('popup-msg').textContent = msg; $('popup').classList.add('show'); },
  hide(){ $('popup').classList.remove('show'); }
};
document.addEventListener('click', e=>{
  if(e.target && (e.target.id==='popup-ok' || e.target.id==='popup-backdrop')) popup.hide();
});

/* fetch with timeout + no noisy UI */
async function api(path, opt={}){
  const url = API + path + (path.includes('?')?'&':'?') + 'v=' + Date.now();
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), 9000);
  try{
    const res = await fetch(url, { method: opt.method||'GET', body: opt.body||undefined, cache: 'no-store', signal: ctrl.signal });
    const raw = await res.text();
    if(!res.ok) throw new Error(raw||('HTTP '+res.status));
    return JSON.parse(raw);
  }finally{ clearTimeout(t); }
}

/* ===== Time defaults ===== */
function setDefaultDateAndTime(){
  const now = new Date();
  const today = now.toISOString().slice(0,10);
  $('date').value = today;
  $('date').min = today;

  let h = now.getHours();
  let m = now.getMinutes();
  if(m>0 && m<=30) m=30; else if(m>30){ m=0; h=(h+1)%24; }

  $('start').value = `${pad(h)}:${pad(m)}`;
  $('end').value   = `${pad((h+1)%24)}:${pad(m)}`;
}
function autoAdjustEnd(){
  const s = $('start').value; if(!s) return;
  const [h,m] = s.split(':').map(Number);
  $('end').value = `${pad((h+1)%24)}:${pad(m)}`;
}

/* ===== LIFF (relaxed) ===== */
let lineUserId = '';
async function initLIFF(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if(liff.isLoggedIn()){
      const p = await liff.getProfile();
      lineUserId = p.userId || '';
      if(!$('by').value) $('by').value = p.displayName || '';
    }else{
      lineUserId = 'GUEST-' + Math.random().toString(36).slice(2,8);
    }
  }catch{
    lineUserId = 'GUEST-' + Math.random().toString(36).slice(2,8);
  }
}

/* ===== Rooms + Dashboard ===== */
let refreshTimer = null;

function renderDash(booked){
  const buckets = { morning:[], noon:[], evening:[], night:[] };
  (booked||[]).forEach(b=>{
    const h = parseInt((b.start||'00:00').split(':')[0],10);
    if(h>=6 && h<12) buckets.morning.push(b);
    else if(h>=12 && h<15) buckets.noon.push(b);
    else if(h>=15 && h<19) buckets.evening.push(b);
    else if(h>=19) buckets.night.push(b);
  });
  const fill = (arr, cid, lid)=>{
    $(cid).textContent = (arr.length||0) + ' รายการ';
    $(lid).innerHTML = arr.length
      ? arr.sort((a,b)=> (a.start||'').localeCompare(b.start||''))
          .map(x=>`<div class="item">[${x.start}-${x.end}] ${x.by||x.purpose||''}</div>`).join('')
      : '<div class="muted">— ว่าง —</div>';
  };
  fill(buckets.morning, 'c-morning', 'l-morning');
  fill(buckets.noon,    'c-noon',    'l-noon');
  fill(buckets.evening, 'c-evening', 'l-evening');
  fill(buckets.night,   'c-night',   'l-night');
}

async function checkSlots(){
  const r = $('room').value, dt = $('date').value;
  if(!r || !dt) return;
  try{
    const d = await api(`?action=slots&room_id=${encodeURIComponent(r)}&date=${encodeURIComponent(dt)}`);
    renderDash((d && d.booked) || []);
  }catch(e){
    // เงียบ ๆ ถ้า API ช้า/ล่ม — ไม่กวนหน้าเพจ
  }
}

function startAutoRefresh(){ stopAutoRefresh(); refreshTimer = setInterval(checkSlots, REFRESH_MS); }
function stopAutoRefresh(){ if(refreshTimer){ clearInterval(refreshTimer); refreshTimer=null; } }

async function loadRoomsAndInitDash(){
  const sel = $('room');
  sel.innerHTML = ''; // ไม่ใส่ "(กำลังโหลด...)" อีกต่อไป

  try{
    const d = await api('?action=rooms');
    const rooms = (d && d.rooms) || [];
    if(rooms.length){
      sel.innerHTML = rooms.map(r=>`<option value="${r.room_id}">${r.room_name||r.name||r.room_id}</option>`).join('');
      if(!sel.value) sel.value = rooms[0].room_id;
      await checkSlots();
      startAutoRefresh();
    }else{
      sel.innerHTML = '<option value="">(ยังไม่มีรายการห้อง)</option>';
    }
  }catch(e){
    // ถ้าโหลดห้องไม่สำเร็จ ให้โชว์ตัวเลือกว่างเฉย ๆ
    sel.innerHTML = '<option value="">(โหลดห้องไม่สำเร็จ)</option>';
  }
}

/* ===== Book ===== */
async function book(){
  const p = {
    room_id: $('room').value,
    date: $('date').value,
    start: $('start').value,
    end: $('end').value,
    book_by: $('by').value,
    purpose: $('purpose').value,
    line_user: lineUserId
  };
  const msg = $('msg');

  if(!p.room_id || !p.date || !p.start || !p.end){
    msg.textContent = '❌ กรอกข้อมูลให้ครบ'; return;
  }
  if(p.end <= p.start){
    popup.show('เวลาสิ้นสุดต้องมากกว่าเวลาเริ่ม'); return;
  }
  if(!p.line_user){
    msg.textContent='❌ ต้องเปิดผ่าน LINE (LIFF) เพื่อยืนยันตัวตนผู้จอง'; return;
  }

  msg.textContent = 'กำลังบันทึก...';
  try{
    const body = new URLSearchParams(); body.set('payload', JSON.stringify(p));
    const res = await api('', { method:'POST', body });
    if(!res.ok){
      const reason = (res.reason||res.error||'').toString().toUpperCase();
      if(reason.includes('TIME_CONFLICT')){
        popup.show('ช่วงเวลานี้ถูกจองแล้ว กรุณาเลือกเวลาอื่น');
        msg.textContent = '❌ เวลาซ้ำ';
      }else{
        popup.show('จองไม่สำเร็จ: '+(res.reason||res.error||''));
        msg.textContent = '❌ ไม่สำเร็จ';
      }
      return;
    }
    msg.textContent = '✅ จองสำเร็จ! Ref: ' + (res.ref||'');
    await checkSlots();
  }catch(e){
    popup.show('เครือข่ายขัดข้อง');
    msg.textContent = '❌ ไม่สำเร็จ';
  }
}

/* ===== Bootstrap ===== */
document.addEventListener('visibilitychange',()=>{
  if(document.hidden) stopAutoRefresh(); else startAutoRefresh();
});

document.addEventListener('DOMContentLoaded', async ()=>{
  // ตั้งค่าเวลา/วันที่ก่อนเสมอ เพื่อไม่ให้ช่อง "ว่าง"
  setDefaultDateAndTime();

  // LIFF แบบเงียบ ๆ (ล้มเหลวก็ guest)
  await initLIFF();

  // โหลดห้องแบบเงียบ ๆ (ไม่แสดง “กำลังโหลด”)
  await loadRoomsAndInitDash();

  // bind UI
  $('start').addEventListener('change', autoAdjustEnd);
  $('room').addEventListener('change', ()=>{ checkSlots(); startAutoRefresh(); });
  $('date').addEventListener('change', ()=>{ checkSlots(); startAutoRefresh(); });
  $('book').addEventListener('click', book);
});
</script>
</body>
</html>
