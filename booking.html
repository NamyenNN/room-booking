<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (Multi-Room Support)</title>
<link rel="icon" type="image/png" href="https://namyennn.github.io/room-booking/LOGOCS.png?v=1">
<style>
  :root {
    --bg: #f3f4f6; --text: #0f172a; --muted: #64748b; --card: #ffffff;
    --primary: #2563eb; --available: #10b981; --line: #e5e7eb;
  }
  @media (prefers-color-scheme: dark) {
    :root { --bg: #020617; --text: #e5e7eb; --muted: #94a3b8; --card: #1e293b; --line: #334155; }
  }
  body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 15px; display: flex; justify-content: center; }
  .page { width: 100%; max-width: 700px; }
  .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid var(--line); }
  
  header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
  header img { width: 50px; height: 50px; border-radius: 12px; }
  h1 { margin: 0; font-size: 22px; font-weight: 800; }
  
  fieldset { border: 1px solid var(--line); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
  legend { font-size: 13px; font-weight: 700; color: var(--muted); padding: 0 10px; }
  
  label { display: block; font-size: 12px; margin-bottom: 5px; color: var(--muted); font-weight: 600; }
  select, input, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--line); background: var(--bg); color: var(--text); font-size: 15px; margin-bottom: 10px; outline: none; }
  select:focus, input:focus { border-color: var(--primary); }

  /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á */
  .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
  .slot-card { background: var(--bg); padding: 12px; border-radius: 15px; text-align: center; border: 1px solid var(--line); }
  .slot-card h3 { margin: 0 0 5px; font-size: 12px; color: var(--muted); }
  .time-list { font-size: 13px; font-weight: 700; color: var(--available); min-height: 40px; display: flex; align-items: center; justify-content: center; flex-direction: column; white-space: pre-line; }
  .status-tag { font-size: 10px; padding: 2px 8px; border-radius: 10px; background: rgba(16,185,129,0.1); color: var(--available); font-weight: 700; margin-top: 5px; display: inline-block; }
  .status-tag.busy { color: #ef4444; background: rgba(239,68,68,0.1); }

  .btn { width: 100%; padding: 15px; border-radius: 15px; border: none; background: var(--primary); color: white; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; }
  .btn:disabled { opacity: 0.5; }
  .footer { text-align: center; margin-top: 15px; font-size: 14px; }
  .footer a { color: var(--primary); text-decoration: none; font-weight: 600; }

  @media (max-width: 500px) { .grid-3 { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<div class="page">
  <div class="card">
    <header>
      <img src="https://namyennn.github.io/room-booking/LOGOCS.png?v=1" alt="Logo">
      <div>
        <h1>‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h1>
        <div style="font-size: 12px; color: var(--muted);">‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡πà‡∏≤‡∏á</div>
      </div>
    </header>

    <fieldset>
      <legend>üè¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</legend>
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô / ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</label>
      <select id="room" onchange="loadSlots()"></select>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input type="date" id="date" onchange="loadSlots()">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
          <div><label>‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="time" id="start"></div>
          <div><label>‡∏ñ‡∏∂‡∏á</label><input type="time" id="end"></div>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend id="status-title">üìä ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</legend>
      <div class="grid-3">
        <div class="slot-card">
          <h3>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ä‡πâ‡∏≤</h3>
          <div id="l-morning" class="time-list">-</div>
          <span id="t-morning" class="status-tag">Ready</span>
        </div>
        <div class="slot-card">
          <h3>‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á-‡∏ö‡πà‡∏≤‡∏¢</h3>
          <div id="l-noon" class="time-list">-</div>
          <span id="t-noon" class="status-tag">Ready</span>
        </div>
        <div class="slot-card">
          <h3>‡πÄ‡∏¢‡πá‡∏ô-‡∏Ñ‡πà‡∏≥</h3>
          <div id="l-evening" class="time-list">-</div>
          <span id="t-evening" class="status-tag">Ready</span>
        </div>
      </div>
    </fieldset>

    <fieldset style="border-style: dashed;">
      <legend>üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</legend>
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô LINE</label>
      <input id="by" readonly placeholder="Loading..." style="opacity: 0.7;">
      <label>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label>
      <textarea id="purpose" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°..."></textarea>
    </fieldset>

    <button id="book" class="btn" onclick="onBook()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
    <div id="msg" class="footer" style="min-height: 20px;"></div>
    
    <div class="footer">
      <a href="my.html">üìÇ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô / ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbyKKtN_gWMWEW30eCjgfWSfF9m1AWPtYweRoPV7VPkPx21HoyhQO5oGGkbi08VsmcxCIQ/exec';
const LIFF_ID  = '2008386695-b1ykgdPk';

const $ = (id) => document.getElementById(id);
let state = { lineUserId: '', lineName: '' };

// Helper: ‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 00:00
const toTime = (m) => `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
// Helper: ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ
const toMin = (t) => { const [h,m] = t.split(':').map(Number); return h*60+m; };

// ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á
function calculateFree(rangeS, rangeE, booked) {
  let free = [{ s: rangeS, e: rangeE }];
  booked.forEach(b => {
    let bs = toMin(b.start), be = toMin(b.end);
    let next = [];
    free.forEach(f => {
      if (bs < f.e && be > f.s) {
        if (bs > f.s) next.push({ s: f.s, e: bs });
        if (be < f.e) next.push({ s: be, e: f.e });
      } else next.push(f);
    });
    free = next;
  });
  return free;
}

async function loadSlots() {
  const room = $('room').value;
  const date = $('date').value;
  if (!room || !date) return;

  $('status-title').textContent = `üìä ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á: ${$('room').options[$('room').selectedIndex].text}`;
  
  try {
    const res = await fetch(`${API_URL}?action=slots&room_id=${encodeURIComponent(room)}&date=${encodeURIComponent(date)}`);
    const d = await res.json();
    const booked = d.booked || [];

    const sections = [
      { id: 'morning', s: 480, e: 720 }, // 08:00-12:00
      { id: 'noon',    s: 720, e: 960 }, // 12:00-16:00
      { id: 'evening', s: 960, e: 1260 } // 16:00-21:00
    ];

    sections.forEach(sec => {
      const free = calculateFree(sec.s, sec.e, booked);
      const listEl = $(`l-${sec.id}`);
      const tagEl = $(`t-${sec.id}`);
      
      if (free.length === 0) {
        listEl.textContent = "‡πÄ‡∏ï‡πá‡∏°";
        listEl.style.color = "#ef4444";
        tagEl.textContent = "Busy"; tagEl.className = "status-tag busy";
      } else {
        const isFull = free.length === 1 && free[0].s === sec.s && free[0].e === sec.e;
        listEl.textContent = isFull ? "‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡πà‡∏ß‡∏á" : free.map(f => `${toTime(f.s)}-${toTime(f.e)}`).join('\n');
        listEl.style.color = "var(--available)";
        tagEl.textContent = "Available"; tagEl.className = "status-tag";
      }
    });
  } catch (e) { console.error("Load error", e); }
}

async function loadRooms() {
  const res = await fetch(`${API_URL}?action=rooms`);
  const d = await res.json();
  const select = $('room');
  select.innerHTML = '<option value="">‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á ‚Äî</option>';
  d.rooms.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r.room_id; opt.textContent = r.room_name || r.room_id;
    select.appendChild(opt);
  });
}

async function initLiff() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (liff.isLoggedIn()) {
      const p = await liff.getProfile();
      state.lineUserId = p.userId;
      state.lineName = p.displayName;
      $('by').value = p.displayName;
    } else { liff.login(); }
  } catch (e) { $('by').value = "Guest Mode"; }
}

async function onBook() {
  const room = $('room').value;
  const date = $('date').value;
  const start = $('start').value;
  const end = $('end').value;
  
  if (!room || !date || !start || !end) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
  if (toMin(end) <= toMin(start)) return alert("‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°");

  $('book').disabled = true;
  $('msg').textContent = "üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

  try {
    const form = new URLSearchParams();
    form.set('payload', JSON.stringify({
      room_id: room, date, start, end,
      book_by: state.lineName || "Guest",
      purpose: $('purpose').value,
      line_user: state.lineUserId
    }));

    const res = await fetch(API_URL, { method: 'POST', body: form });
    const r = await res.json();
    
    if (r.ok) {
      alert(`‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ${r.ref}`);
      loadSlots();
    } else {
      alert(`‚ùå ‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${r.message || r.error}`);
    }
  } catch (e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠"); }
  finally { $('book').disabled = false; $('msg').textContent = ""; }
}

document.addEventListener('DOMContentLoaded', async () => {
  $('date').value = new Date().toISOString().slice(0, 10);
  await loadRooms();
  await initLiff();
});
</script>
</body>
</html>
