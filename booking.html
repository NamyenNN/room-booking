<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
<link rel="icon" type="image/png" href="https://namyennn.github.io/room-booking/LOGOCS.png?v=1">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  /* ============== THEME TOKENS ============== */
  :root {
    --bg: #f8fafc;
    --card: #ffffff;
    --text: #1e293b;
    --muted: #64748b;
    --primary: #2563eb;
    --primary-soft: rgba(37, 99, 235, 0.1);
    --available: #10b981;
    --busy: #ef4444;
    --line: #e2e8f0;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --primary: #60a5fa;
      --line: #334155;
    }
  }

  /* ============== BASE STYLE ============== */
  * { box-sizing: border-box; transition: all 0.2s ease; }
  body {
    font-family: 'IBM Plex Sans Thai', sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 16px;
    display: flex;
    justify-content: center;
    line-height: 1.5;
  }

  .container { width: 100%; max-width: 650px; animation: fadeIn 0.6s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .main-card {
    background: var(--card);
    border-radius: 24px;
    padding: 24px;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    border: 1px solid var(--line);
  }

  header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
  header img { width: 56px; height: 56px; border-radius: 14px; border: 1px solid var(--line); }
  h1 { margin: 0; font-size: 24px; font-weight: 700; }
  .subtitle { font-size: 13px; color: var(--muted); }

  /* ============== FORM STYLE ============== */
  fieldset { border: 1px solid var(--line); border-radius: 16px; padding: 16px; margin-bottom: 20px; }
  legend { font-size: 14px; font-weight: 600; color: var(--primary); padding: 0 10px; }
  
  label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--muted); }
  select, input, textarea {
    width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--line);
    background: var(--bg); color: var(--text); font-family: inherit; font-size: 15px; margin-bottom: 12px;
  }
  select:focus, input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-soft); }

  /* ============== TIMELINE STYLE (CLEAR) ============== */
  .grid-timeline { display: grid; grid-template-columns: 1fr; gap: 12px; }
  .slot-card { background: var(--bg); padding: 14px; border-radius: 16px; border: 1px solid var(--line); }
  .slot-card h3 { margin: 0 0 10px; font-size: 13px; color: var(--muted); text-transform: uppercase; }

  .time-list { display: flex; flex-direction: column; gap: 6px; }
  .time-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 12px; border-radius: 10px; font-size: 14px; font-weight: 600;
  }
  .time-item.free { background: rgba(16, 185, 129, 0.1); color: var(--available); border-left: 4px solid var(--available); }
  .time-item.busy { background: rgba(239, 68, 68, 0.1); color: var(--busy); border-left: 4px solid var(--busy); }
  .time-item span { font-size: 11px; opacity: 0.8; }

  /* ============== BUTTONS ============== */
  .btn-book {
    width: 100%; padding: 16px; border-radius: 16px; border: none;
    background: var(--primary); color: white; font-size: 17px; font-weight: 700;
    cursor: pointer; box-shadow: 0 4px 12px var(--primary-soft);
  }
  .btn-book:hover { transform: translateY(-2px); filter: brightness(1.1); }
  .btn-book:disabled { opacity: 0.5; transform: none; }

  .footer { text-align: center; margin-top: 16px; font-size: 14px; }
  .footer a { color: var(--primary); text-decoration: none; font-weight: 600; }
</style>
</head>
<body>

<div class="container">
  <div class="main-card">
    <header>
      <img src="https://namyennn.github.io/room-booking/LOGOCS.png?v=1" alt="Logo">
      <div>
        <h1>Reservation</h1>
        <div class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ ‚Ä¢ CS Room</div>
      </div>
    </header>

    <fieldset>
      <legend>üè¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</legend>
      <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà / ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</label>
      <select id="room" onchange="loadSlots()"></select>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div>
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input type="date" id="date" onchange="loadSlots()">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <div><label>‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="time" id="start"></div>
          <div><label>‡∏ñ‡∏∂‡∏á</label><input type="time" id="end"></div>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend id="status-title">üìä ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</legend>
      <div class="grid-timeline">
        <div class="slot-card">
          <h3>üåÖ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ä‡πâ‡∏≤ (06:00 - 12:00)</h3>
          <div id="l-morning" class="time-list"></div>
        </div>
        <div class="slot-card">
          <h3>‚òÄÔ∏è ‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢ (12:00 - 17:00)</h3>
          <div id="l-noon" class="time-list"></div>
        </div>
        <div class="slot-card">
          <h3>üåô ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏¢‡πá‡∏ô (17:00 - 22:00)</h3>
          <div id="l-evening" class="time-list"></div>
        </div>
      </div>
    </fieldset>

    <fieldset style="border-style: dashed; background: var(--bg);">
      <legend>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</legend>
      <label>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (LINE Account)</label>
      <input id="by" readonly placeholder="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE..." style="background: transparent; border: none; font-weight: 700; font-size: 16px;">
      
      <label>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</label>
      <textarea id="purpose" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á..."></textarea>
    </fieldset>

    <button id="book" class="btn-book" onclick="onBook()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
    
    <div class="footer">
      <p id="msg" style="min-height: 24px; font-weight: 500;"></p>
      <a href="my.html">üìÇ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô / ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
/* ===================== CONFIG ===================== */
const API_URL = 'https://script.google.com/macros/s/AKfycbyKKtN_gWMWEW30eCjgfWSfF9m1AWPtYweRoPV7VPkPx21HoyhQO5oGGkbi08VsmcxCIQ/exec';
const LIFF_ID  = '2008386695-b1ykgdPk';

const $ = (id) => document.getElementById(id);
let state = { lineUserId: '', lineName: '' };

/* ===================== TIME LOGIC ===================== */
const toTime = (m) => `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
const toMin = (t) => { const [h,m] = t.split(':').map(Number); return h*60+m; };

function calculateFree(rangeS, rangeE, booked) {
  let free = [{ s: rangeS, e: rangeE }];
  booked.forEach(b => {
    let bs = toMin(b.start), be = toMin(b.end);
    let next = [];
    free.forEach(f => {
      if (bs < f.e && be > f.s) {
        if (bs > f.s) next.push({ s: f.s, e: bs });
        if (be < f.e) next.push({ s: be, e: f.e });
      } else next.push(f);
    });
    free = next;
  });
  return free;
}

/* ===================== API & DATA ===================== */
async function loadSlots() {
  const room = $('room').value;
  const date = $('date').value;
  if (!room || !date) return;

  $('status-title').textContent = `üìä ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡∏≠‡∏á: ${$('room').options[$('room').selectedIndex].text}`;
  
  try {
    const res = await fetch(`${API_URL}?action=slots&room_id=${encodeURIComponent(room)}&date=${encodeURIComponent(date)}`);
    const d = await res.json();
    const booked = d.booked || [];

    const sections = [
      { id: 'morning', s: 360, e: 720 }, // 06:00-12:00
      { id: 'noon',    s: 720, e: 1020 }, // 12:00-17:00
      { id: 'evening', s: 1020, e: 1320 } // 17:00-22:00
    ];

    sections.forEach(sec => {
      const listEl = $(`l-${sec.id}`);
      listEl.innerHTML = '';
      
      const inSec = booked.filter(b => toMin(b.start) < sec.e && toMin(b.end) > sec.s);
      
      // 1. Show Busy (Red)
      inSec.sort((a,b) => toMin(a.start) - toMin(b.start)).forEach(b => {
        listEl.innerHTML += `<div class="time-item busy"><span>‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span> ${b.start} - ${b.end}</div>`;
      });

      // 2. Show Free (Green)
      const free = calculateFree(sec.s, sec.e, inSec);
      if(free.length === 0) {
        listEl.innerHTML += `<div style="text-align:center; font-size:12px; color:var(--busy);">‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>`;
      } else {
        free.forEach(f => {
          listEl.innerHTML += `<div class="time-item free"><span>‡∏ß‡πà‡∏≤‡∏á</span> ${toTime(f.s)} - ${toTime(f.e)}</div>`;
        });
      }
    });
  } catch (e) { console.error(e); }
}

async function loadRooms() {
  const res = await fetch(`${API_URL}?action=rooms`);
  const d = await res.json();
  const select = $('room');
  select.innerHTML = '<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° ‚Äî</option>';
  d.rooms.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r.room_id; opt.textContent = r.room_name || r.room_id;
    select.appendChild(opt);
  });
}

async function initLiff() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (liff.isLoggedIn()) {
      const p = await liff.getProfile();
      state.lineUserId = p.userId;
      state.lineName = p.displayName;
      $('by').value = p.displayName;
    } else { liff.login(); }
  } catch (e) { $('by').value = "‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô"; }
}

async function onBook() {
  const room = $('room').value;
  const date = $('date').value;
  const start = $('start').value;
  const end = $('end').value;
  
  if (!room || !date || !start || !end) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
  if (toMin(end) <= toMin(start)) return alert("‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°");

  $('book').disabled = true;
  $('msg').textContent = "üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á...";

  try {
    const form = new URLSearchParams();
    form.set('payload', JSON.stringify({
      room_id: room, date, start, end,
      book_by: state.lineName || "Guest",
      purpose: $('purpose').value,
      line_user: state.lineUserId
    }));

    const res = await fetch(API_URL, { method: 'POST', body: form });
    const r = await res.json();
    
    if (r.ok) {
      alert(`‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!\n‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ${r.ref}`);
      loadSlots();
    } else {
      alert(`‚ùå ‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${r.message || r.error}`);
    }
  } catch (e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); }
  finally { $('book').disabled = false; $('msg').textContent = ""; }
}

document.addEventListener('DOMContentLoaded', async () => {
  $('date').value = new Date().toISOString().slice(0, 10);
  await loadRooms();
  await initLiff();
});
</script>
</body>
</html>
