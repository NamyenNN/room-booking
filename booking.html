<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>จองห้องประชุม</title>
<style>
  body{font-family:system-ui,Segoe UI,Arial;padding:16px;max-width:720px;margin:auto}
  fieldset{border:1px solid #ddd;padding:12px;margin-bottom:16px;border-radius:8px}
  label{display:block;margin:8px 0 4px}
  input,select,button,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .pill{display:inline-block;padding:4px 8px;border:1px solid #ccc;border-radius:999px;margin:4px 6px 0 0}
  .bad{color:#b00020}
  .hint{font-size:12px;color:#666}
  details{margin-top:14px}
  pre{white-space:pre-wrap}
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
<h1>จองห้องประชุม</h1>

<fieldset><legend>เลือกห้องและวันเวลา</legend>
  <label>ห้อง</label>
  <select id="room"><option value="">(กำลังโหลด...)</option></select>
  <div class="row">
    <div><label>วันที่</label><input type="date" id="date"></div>
    <div><label>เวลาเริ่ม</label><input type="time" id="start" value="09:00"></div>
  </div>
  <div class="row">
    <div><label>เวลาสิ้นสุด</label><input type="time" id="end" value="10:00"></div>
    <div><label>&nbsp;</label><button id="check">เช็กคิว</button></div>
  </div>
  <div id="slots"></div>
</fieldset>

<fieldset><legend>ข้อมูลผู้จอง</legend>
  <label>ชื่อผู้จอง</label><input id="by" placeholder="จะเติมจาก LINE ให้อัตโนมัติ">
  <label>วัตถุประสงค์</label><textarea id="purpose" rows="2" placeholder="เช่น ประชุมโครงการ..."></textarea>
</fieldset>

<button id="book">ยืนยันการจอง</button>
<p id="msg" class="hint"></p>
<p><a href="my.html">ไปที่ “การจองของฉัน / ยกเลิก”</a></p>

<details><summary>DEBUG</summary><pre id="debug"></pre></details>

<script>
  // ===== ตั้งค่าของคุณ =====
  // ใช้ URL /exec ของ Apps Script (ห้ามมี ?action ติดในตัวแปรนี้)
  const API = 'https://script.google.com/macros/s/AKfycbzX3qDwakFm0-Fls1O4_fDuiZMauPzGeuuhB-7HRPcw/exec';
  const LIFF_ID = '2008386695-b1ykgdPk';
  // =========================

  let lineUserId = '';
  const $ = (id)=>document.getElementById(id);
  const log = (t)=>{ const el=$('debug'); if(el) el.textContent += t+'\n'; };

  // เรียก API พร้อมกันแคช + โชว์สาเหตุเมื่อพลาด
  async function api(path, opt={}) {
    const url = API + path + (path.includes('?') ? '&' : '?') + 'v=' + Date.now();
    log('API: '+url);
    try{
      const res = await fetch(url, {
        method: opt.method || 'GET',
        headers: opt.headers || {'Accept':'application/json'},
        body: opt.body || undefined,
        mode: 'cors', credentials: 'omit', cache: 'no-store',
        redirect: 'follow', referrerPolicy: 'no-referrer'
      });
      const raw = await res.text().catch(()=> '');
      log('HTTP: '+res.status+' RAW: '+raw.slice(0,120));
      if(!res.ok) throw new Error('HTTP '+res.status+' '+raw.slice(0,200));
      try { return JSON.parse(raw); } catch { throw new Error('BAD JSON: '+raw.slice(0,200)); }
    }catch(e){
      if ($('slots')) {
        $('slots').innerHTML = '<pre>❌ API failed\nURL: '+url+'\nReason: '+String(e)+'</pre>';
      }
      throw e;
    }
  }

  function toPill(t,bad=false){
    const el=document.createElement('span');
    el.className='pill'+(bad?' bad':''); el.textContent=t; return el;
  }

  // --- บังคับล็อกอินก่อนเสมอ ---
  async function initLIFFRequire(){
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) {
      // กลับมาหน้าเดิมหลังล็อกอิน
      liff.login({ redirectUri: location.href });
      return; // จะ redirect ออกไป
    }
    const p = await liff.getProfile();
    lineUserId = p.userId || '';
    if (!$('by').value) $('by').value = p.displayName || '';
    log('LIFF OK user='+lineUserId);
  }

  // --- โหลดรายชื่อห้อง (เรียกหลังจากล็อกอินแล้ว) ---
  async function loadRooms(){
    const sel = $('room'); const slots = $('slots');
    try{
      const d = await api('?action=rooms');
      if(!d.ok) throw new Error(d.error||'API not ok');
      const rooms = d.rooms || [];
      if(rooms.length===0){
        sel.innerHTML = '<option value="">(ยังไม่มีห้องในชีต Rooms แถว 2)</option>';
        slots.textContent = 'กรอก A:room_id, B:room_name, C:capacity, D:note ตั้งแต่แถวที่ 2';
        return;
      }
      sel.innerHTML = '';
      rooms.forEach(r=>{
        const o=document.createElement('option');
        o.value=r.room_id; o.textContent=r.room_name||r.room_id;
        sel.appendChild(o);
      });
      log('rooms.length='+rooms.length);
    }catch(e){
      sel.innerHTML = '<option value="">(โหลดห้องไม่สำเร็จ)</option>';
      slots.innerHTML = '<pre>❌ โหลดห้องไม่สำเร็จ\nสาเหตุ: '+String(e)+'\nAPI: '+API+'\nหน้าปัจจุบัน: '+location.href+'</pre>';
    }
  }

  async function checkSlots(){
    const r = $('room').value, dt = $('date').value;
    if(!r||!dt){ alert('กรุณาเลือกห้องและวันที่'); return; }
    const d = await api(`?action=slots&room_id=${encodeURIComponent(r)}&date=${encodeURIComponent(dt)}`);
    const box = $('slots'); box.innerHTML='';
    if(d.booked && d.booked.length){
      box.append('ช่วงเวลาที่ถูกจองแล้ว: ');
      d.booked.forEach(b=>box.appendChild(toPill(`${b.start}-${b.end} (${b.by||'-'})`,true)));
    }else{
      box.textContent='วันนี้ยังว่างทั้งหมด ✅';
    }
  }

  async function book(){
    const payload = {
      room_id: $('room').value, date: $('date').value,
      start: $('start').value, end: $('end').value,
      book_by: $('by').value,  purpose: $('purpose').value,
      line_user: lineUserId
    };
    const msg = $('msg');
    if(!payload.room_id||!payload.date||!payload.start||!payload.end){
      msg.textContent='❌ กรุณากรอกข้อมูลให้ครบ'; return;
    }
    if(!payload.line_user){
      msg.textContent='❌ ต้องเปิดผ่าน LINE (LIFF) เพื่อยืนยันตัวตนผู้จอง'; return;
    }
    msg.textContent='กำลังบันทึก...';
    try{
      const res = await api('', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      msg.textContent = res.ok ? `จองสำเร็จ! Ref: ${res.ref}` : `❌ ไม่สำเร็จ: ${res.reason||res.error}`;
      if(res.ok) checkSlots();
    }catch(e){
      msg.textContent = '❌ ไม่สำเร็จ: ' + String(e);
    }
  }

  // ลำดับทำงาน: login → rooms → set date & bind buttons
  document.addEventListener('DOMContentLoaded', async ()=>{
    await initLIFFRequire();               // 1) บังคับล็อกอินก่อน (จะ redirect ถ้ายังไม่ได้ล็อกอิน)
    await loadRooms();                     // 2) กลับมาแล้วค่อยโหลดห้อง
    $('date').value = new Date().toISOString().slice(0,10);
    $('check').onclick = checkSlots;
    $('book').onclick  = book;
    log('READY');
  });
</script>
</body>
</html>
