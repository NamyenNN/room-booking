<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard แอดมิน - จองห้องประชุม</title>
<link rel="icon" type="image/png" href="https://namyennn.github.io/room-booking/LOGOCS.png?v=1">
<style>
body{
  font-family:system-ui,Segoe UI,Arial;
  padding:16px;
  max-width:980px;
  margin:auto;
  background:#f3f4f6;
}
.card{
  background:#ffffff;
  border-radius:16px;
  padding:16px 20px 20px;
  box-shadow:0 10px 25px rgba(15,23,42,0.08);
  border:1px solid #e5e7eb;
}
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
}
.brand{display:flex;gap:12px;align-items:center;}
.brand-logo{width:44px;height:44px;border-radius:12px;}
.btn{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  background:#3b82f6;
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
.btn.secondary{background:#fff;color:#0f172a;}
.hint{font-size:12px;color:#666;}
.bad{color:#b00020}
.ok{color:#0a7}
.modal{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  background:rgba(0,0,0,.55);
  z-index:9999;
}
.modal-box{
  background:#fff;
  padding:20px;
  border-radius:16px;
  max-width:420px;
  width:90%;
}
</style>
</head>

<body>

<!-- LOGIN MODAL -->
<div class="modal" id="loginModal">
  <div class="modal-box">
    <h3>Admin Login</h3>
    <label>Username</label>
    <input id="admin_user">
    <label>Password</label>
    <input id="admin_pass" type="password">
    <div style="margin-top:12px;display:flex;gap:8px">
      <button class="btn" id="btnLogin">Login</button>
    </div>
    <div id="loginMsg" class="hint"></div>
  </div>
</div>

<!-- SESSION EXPIRED -->
<div class="modal" id="expiredModal">
  <div class="modal-box">
    <h3>Session หมดอายุ</h3>
    <p class="hint">กรุณา Login ใหม่</p>
    <button class="btn" id="btnRelogin">Login ใหม่</button>
  </div>
</div>

<div class="card">
  <div class="topbar">
    <div class="brand">
      <img src="https://namyennn.github.io/room-booking/LOGOCS.png?v=1" class="brand-logo">
      <div>
        <b>Dashboard Admin</b>
        <div id="whoami" class="hint">ยังไม่เข้าสู่ระบบ</div>
      </div>
    </div>
    <button class="btn secondary" id="btnLogoutTop">Log out</button>
  </div>

  <div style="margin-top:12px">
    <button class="btn" id="load">โหลดรายการจอง</button>
    <div id="msg" class="hint"></div>
    <div id="tablebox"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API = 'https://script.google.com/macros/s/AKfycbyKKtN_gWMWEW30eCjgfWSfF9m1AWPtYweRoPV7VPkPx21HoyhQO5oGGkbi08VsmcxCIQ/exec';

const TOKEN_KEY='room_admin_token';
const USER_KEY='room_admin_user';
const EXP_KEY='room_admin_token_exp';

const $=id=>document.getElementById(id);
const msg=(t,c='')=>{$('msg').textContent=t;$('msg').className='hint '+c};

/* ===== AUTH ===== */
function setToken(token,user,exp){
  localStorage.setItem(TOKEN_KEY,token);
  localStorage.setItem(USER_KEY,user);
  localStorage.setItem(EXP_KEY,exp);
}
function clearToken(){
  localStorage.clear();
}
function tokenExpired(){
  const exp=Number(localStorage.getItem(EXP_KEY)||0);
  return !exp || Date.now()>exp;
}
function requireAuth(){
  if(tokenExpired()){
    clearToken();
    $('expiredModal').style.display='flex';
    return false;
  }
  return true;
}

/* ===== LOGIN ===== */
async function login(){
  const u=$('admin_user').value;
  const p=$('admin_pass').value;
  const r=await fetch(`${API}?action=adminlogin&user=${u}&pass=${p}`).then(r=>r.json());
  if(r.ok){
    setToken(r.token,r.user,r.exp);
    $('loginModal').style.display='none';
    $('whoami').textContent='เข้าสู่ระบบแล้ว ('+r.user+')';
    loadTable();
  }else{
    $('loginMsg').textContent='รหัสไม่ถูกต้อง';
  }
}

/* ===== DATA ===== */
async function loadTable(){
  if(!requireAuth()) return;
  const token=localStorage.getItem(TOKEN_KEY);
  const r=await fetch(`${API}?action=admin_calendar&date_from=2025-01-01&date_to=2026-12-31&token=${token}`).then(r=>r.json());
  if(!r.ok){
    clearToken();
    $('expiredModal').style.display='flex';
    return;
  }
  $('tablebox').innerHTML='<pre>'+JSON.stringify(r.items,null,2)+'</pre>';
}

/* ===== EVENTS ===== */
$('btnLogin').onclick=login;
$('btnRelogin').onclick=()=>{location.reload()};
$('btnLogoutTop').onclick=()=>{
  if(confirm('ออกจากระบบ?')){
    clearToken();
    location.reload();
  }
};
$('load').onclick=loadTable;

/* ===== INIT ===== */
if(localStorage.getItem(TOKEN_KEY) && !tokenExpired()){
  $('loginModal').style.display='none';
  $('whoami').textContent='เข้าสู่ระบบแล้ว';
}else{
  $('loginModal').style.display='flex';
}
</script>
</body>
</html>
